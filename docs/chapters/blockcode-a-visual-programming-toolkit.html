
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>500 Lines or Less | Blockcode: A visual programming toolkit &#8212; Learn-Computer-and-Math-again 0.0.1 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="prev" title="Welcome to Learn-Computer-and-Math-again&#39;s documentation!" href="../index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="lines-or-less-blockcode-a-visual-programming-toolkit">
<h1>500 Lines or Less | Blockcode: A visual programming toolkit<a class="headerlink" href="#lines-or-less-blockcode-a-visual-programming-toolkit" title="永久链接至标题">¶</a></h1>
<div class="container"><div class="row"><div class="hero-unit"><p><a href="#id1"><span class="problematic" id="id2">``</span></a>_
.. rubric:: Blockcode: A visual programming toolkit</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">name:</th><td class="field-body">blockcode-a-visual-programming-toolkit</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="author rubric" id="dethe-elza">Dethe Elza</p>
</div></div><div class="row"><div id="content" class="span10 offset1"><p><em>`Dethe`_ is a geek dad, aesthetic programmer, mentor, and creator of
the `Waterbear`_ visual programming tool. He co-hosts the Vancouver
Maker Education Salons and wants to fill the world with robotic origami
rabbits.</em></p>
<p>In block-based programming languages, you write programs by dragging and
connecting blocks that represent parts of the program. Block-based
languages differ from conventional programming languages, in which you
type words and symbols.</p>
<p>Learning a programming language can be difficult because they are
extremely sensitive to even the slightest of typos. Most programming
languages are case-sensitive, have obscure syntax, and will refuse to
run if you get so much as a semicolon in the wrong place—or worse, leave
one out. Further, most programming languages in use today are based on
English and their syntax cannot be localized.</p>
<p>In contrast, a well-done block language can eliminate syntax errors
completely. You can still create a program which does the wrong thing,
but you cannot create one with the wrong syntax: the blocks just won't
fit that way. Block languages are more discoverable: you can see all the
constructs and libraries of the language right in the list of blocks.
Further, blocks can be localized into any human language without
changing the meaning of the programming language.</p>
<div class="center figure"><p><img alt="Figure 1.1 - The Blockcode IDE in use" src="chapters/blockcode-images/blockcode_ide.png" /></p>
</div><p>Figure 1.1 - The Blockcode IDE in use</p>
<p>Block-based languages have a long history, with some of the prominent
ones being <a class="reference external" href="http://www.lego.com/en-us/mindstorms/">Lego Mindstorms</a>, <a class="reference external" href="http://www.alice.org/index.php">Alice3D</a>, <a class="reference external" href="http://education.mit.edu/projects/starlogo-tng">StarLogo</a>, and especially
<a class="reference external" href="http://scratch.mit.edu/">Scratch</a>. There are several tools for block-based programming on the
web as well: <a class="reference external" href="https://developers.google.com/blockly/">Blockly</a>, <a class="reference external" href="http://appinventor.mit.edu/explore/">AppInventor</a>, <a class="reference external" href="http://www.tynker.com/">Tynker</a>, and <a class="reference external" href="http://en.wikipedia.org/wiki/Visual_programming_language">many more</a>.</p>
<p>The code in this chapter is loosely based on the open-source project
<a class="reference external" href="http://waterbearlang.com/">Waterbear</a>, which is not a language but a tool for wrapping existing
languages with a block-based syntax. Advantages of such a wrapper
include the ones noted above: eliminating syntax errors, visual display
of available components, ease of localization. Additionally, visual code
can sometimes be easier to read and debug, and blocks can be used by
pre-typing children. (We could even go further and put icons on the
blocks, either in conjunction with the text names or instead of them, to
allow pre-literate children to write programs, but we don't go that far
in this example.)</p>
<p>The choice of turtle graphics for this language goes back to the Logo
language, which was created specifically to teach programming to
children. Several of the block-based languages above include turtle
graphics, and it is a small enough domain to be able to capture in a
tightly constrained project such as this.</p>
<p>If you would like to get a feel for what a block-based-language is like,
you can experiment with the program that is built in this chapter from
author's <a class="reference external" href="https://dethe.github.io/500lines/blockcode/">GitHub repository</a>.</p>
<p class="rubric" id="goals-and-structure">Goals and Structure</p>
<p>I want to accomplish a couple of things with this code. First and
foremost, I want to implement a block language for turtle graphics, with
which you can write code to create images through simple
dragging-and-dropping of blocks, using as simple a structure of HTML,
CSS, and JavaScript as possible. Second, but still important, I want to
show how the blocks themselves can serve as a framework for other
languages besides our mini turtle language.</p>
<p>To do this, we encapsulate everything that is specific to the turtle
language into one file (<code class="docutils literal"><span class="pre">turtle.js</span></code>) that we can easily swap with
another file. Nothing else should be specific to the turtle language;
the rest should just be about handling the blocks (<code class="docutils literal"><span class="pre">blocks.js</span></code> and
<code class="docutils literal"><span class="pre">menu.js</span></code>) or be generally useful web utilities (<code class="docutils literal"><span class="pre">util.js</span></code>,
<code class="docutils literal"><span class="pre">drag.js</span></code>, <code class="docutils literal"><span class="pre">file.js</span></code>). That is the goal, although to maintain the
small size of the project, some of those utilities are less
general-purpose and more specific to their use with the blocks.</p>
<p>One thing that struck me when writing a block language was that the
language is its own IDE. You can't just code up blocks in your favourite
text editor; the IDE has to be designed and developed in parallel with
the block language. This has some pros and cons. On the plus side,
everyone will use a consistent environment and there is no room for
religious wars about what editor to use. On the downside, it can be a
huge distraction from building the block language itself.</p>
<p class="rubric" id="the-nature-of-scripts">The Nature of Scripts</p>
<p>A Blockcode script, like a script in any language (whether block- or
text-based), is a sequence of operations to be followed. In the case of
Blockcode the script consists of HTML elements which are iterated over,
and which are each associated with a particular JavaScript function
which will be run when that block's turn comes. Some blocks can contain
(and are responsible for running) other blocks, and some blocks can
contain numeric arguments which are passed to the functions.</p>
<p>In most (text-based) languages, a script goes through several stages: a
lexer converts the text into recognized tokens, a parser organizes the
tokens into an abstract syntax tree, then depending on the language the
program may be compiled into machine code or fed into an interpreter.
That's a simplification; there can be more steps. For Blockcode, the
layout of the blocks in the script area already represents our abstract
syntax tree, so we don't have to go through the lexing and parsing
stages. We use the Visitor pattern to iterate over those blocks and call
predefined JavaScript functions associated with each block to run the
program.</p>
<p>There is nothing stopping us from adding additional stages to be more
like a traditional language. Instead of simply calling associated
JavaScript functions, we could replace <code class="docutils literal"><span class="pre">turtle.js</span></code> with a block
language that emits byte codes for a different virtual machine, or even
C++ code for a compiler. Block languages exist (as part of the Waterbear
project) for generating Java robotics code, for programming Arduino, and
for scripting Minecraft running on Raspberry Pi.</p>
<p class="rubric" id="web-applications">Web Applications</p>
<p>In order to make the tool available to the widest possible audience, it
is web-native. It's written in HTML, CSS, and JavaScript, so it should
work in most browsers and platforms.</p>
<p>Modern web browsers are powerful platforms, with a rich set of tools for
building great apps. If something about the implementation became too
complex, I took that as a sign that I wasn't doing it &quot;the web way&quot; and,
where possible, tried to re-think how to better use the browser tools.</p>
<p>An important difference between web applications and traditional desktop
or server applications is the lack of a <code class="docutils literal"><span class="pre">main()</span></code> or other entry point.
There is no explicit run loop because that is already built into the
browser and implicit on every web page. All our code will be parsed and
executed on load, at which point we can register for events we are
interested in for interacting with the user. After the first run, all
further interaction with our code will be through callbacks we set up
and register, whether we register those for events (like mouse
movement), timeouts (fired with the periodicity we specify), or frame
handlers (called for each screen redraw, generally 60 frames per
second). The browser does not expose full-featured threads either (only
shared-nothing web workers).</p>
<p class="rubric" id="stepping-through-the-code">Stepping Through the Code</p>
<p>I've tried to follow some conventions and best practices throughout this
project. Each JavaScript file is wrapped in a function to avoid leaking
variables into the global environment. If it needs to expose variables
to other files it will define a single global per file, based on the
filename, with the exposed functions in it. This will be near the end of
the file, followed by any event handlers set by that file, so you can
always glance at the end of a file to see what events it handles and
what functions it exposes.</p>
<p>The code style is procedural, not object-oriented or functional. We
could do the same things in any of these paradigms, but that would
require more setup code and wrappers to impose on what exists already
for the DOM. Recent work on <a class="reference external" href="http://webcomponents.org/">Custom Elements</a> make it easier to work
with the DOM in an OO way, and there has been a lot of great writing on
<a class="reference external" href="https://leanpub.com/javascript-allonge/read">Functional JavaScript</a>, but either would require a bit of
shoe-horning, so it felt simpler to keep it procedural.</p>
<p>There are eight source files in this project, but <code class="docutils literal"><span class="pre">index.html</span></code> and
<code class="docutils literal"><span class="pre">blocks.css</span></code> are basic structure and style for the app and won't be
discussed. Two of the JavaScript files won't be discussed in any detail
either: <code class="docutils literal"><span class="pre">util.js</span></code> contains some helpers and serves as a bridge between
different browser implementations—similar to a library like jQuery but
in less than 50 lines of code. <code class="docutils literal"><span class="pre">file.js</span></code> is a similar utility used for
loading and saving files and serializing scripts.</p>
<p>These are the remaining files:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">block.js</span></code> is the abstract representation of a block-based
language.</li>
<li><code class="docutils literal"><span class="pre">drag.js</span></code> implements the key interaction of the language: allowing
the user to drag blocks from a list of available blocks (the &quot;menu&quot;)
to assemble them into a program (the &quot;script&quot;).</li>
<li><code class="docutils literal"><span class="pre">menu.js</span></code> has some helper code and is also responsible for actually
running the user's program.</li>
<li><code class="docutils literal"><span class="pre">turtle.js</span></code> defines the specifics of our block language (turtle
graphics) and initializes its specific blocks. This is the file that
would be replaced in order to create a different block language.</li>
</ul>
<p class="rubric" id="blocks-js"><code class="docutils literal"><span class="pre">blocks.js</span></code></p>
<p>Each block consists of a few HTML elements, styled with CSS, with some
JavaScript event handlers for dragging-and-dropping and modifying the
input argument. The <code class="docutils literal"><span class="pre">blocks.js</span></code> file helps to create and manage these
groupings of elements as single objects. When a type of block is added
to the block menu, it is associated with a JavaScript function to
implement the language, so each block in the script has to be able to
find its associated function and call it when the script runs.</p>
<div class="center figure"><p><img alt="Figure 1.2 - An example block" src="chapters/blockcode-images/block.png" /></p>
</div><p>Figure 1.2 - An example block</p>
<p>Blocks have two optional bits of structure. They can have a single
numeric parameter (with a default value), and they can be a container
for other blocks. These are hard limits to work with, but would be
relaxed in a larger system. In Waterbear there are also expression
blocks which can be passed in as parameters; multiple parameters of a
variety of types are supported. Here in the land of tight constraints
we'll see what we can do with just one type of parameter.</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span>&lt;!-- The HTML structure of a block --&gt;
&lt;div class=&quot;block&quot; draggable=&quot;true&quot; data-name=&quot;Right&quot;&gt;
    Right
    &lt;input type=&quot;number&quot; value=&quot;5&quot;&gt;
    degrees
&lt;/div&gt;
</pre></div>
</div>
<p>It's important to note that there is no real distinction between blocks
in the menu and blocks in the script. Dragging treats them slightly
differently based on where they are being dragged from, and when we run
a script it only looks at the blocks in the script area, but they are
fundamentally the same structures, which means we can clone the blocks
when dragging from the menu into the script.</p>
<p>The <code class="docutils literal"><span class="pre">createBlock(name,</span> <span class="pre">value,</span> <span class="pre">contents)</span></code> function returns a block as a
DOM element populated with all internal elements, ready to insert into
the document. This can be used to create blocks for the menu, or for
restoring script blocks saved in files or <code class="docutils literal"><span class="pre">localStorage</span></code>. While it is
flexible this way, it is built specifically for the Blockcode &quot;language&quot;
and makes assumptions about it, so if there is a value it assumes the
value represents a numeric argument and creates an input of type
&quot;number&quot;. Since this is a limitation of the Blockcode, this is fine, but
if we were to extend the blocks to support other types of arguments, or
more than one argument, the code would have to change.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">createBlock</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">contents</span><span class="p">){</span>
    <span class="n">var</span> <span class="n">item</span> <span class="o">=</span> <span class="n">elem</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="n">draggable</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="s1">&#39;data-name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
        <span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!==</span> <span class="n">undefined</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!==</span> <span class="n">null</span><span class="p">){</span>
        <span class="n">item</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">elem</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">}));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">isArray</span><span class="p">(</span><span class="n">contents</span><span class="p">)){</span>
        <span class="n">item</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span>
            <span class="n">elem</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;container&#39;</span><span class="p">},</span> <span class="n">contents</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">block</span><span class="p">){</span>
            <span class="k">return</span> <span class="n">createBlock</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
        <span class="p">})));</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">typeof</span> <span class="n">contents</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">){</span>
        <span class="o">//</span> <span class="n">Add</span> <span class="n">units</span> <span class="p">(</span><span class="n">degrees</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span> <span class="n">specifier</span>
        <span class="n">item</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">createTextNode</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">contents</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">item</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We have some utilities for handling blocks as DOM elements:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">blockContents(block)</span></code> retrieves the child blocks of a container
block. It always returns a list if called on a container block, and
always returns null on a simple block</li>
<li><code class="docutils literal"><span class="pre">blockValue(block)</span></code> returns the numerical value of the input on a
block if the block has an input field of type number, or null if
there is no input element for the block</li>
<li><code class="docutils literal"><span class="pre">blockScript(block)</span></code> will return a structure suitable for
serializing with JSON, to save blocks in a form they can easily be
restored from</li>
<li><code class="docutils literal"><span class="pre">runBlocks(blocks)</span></code> is a handler that runs each block in an array
of blocks</li>
</ul>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>function blockContents(block){
    var container = block.querySelector(&#39;.container&#39;);
    return container ? [].slice.call(container.children) : null;
}

function blockValue(block){
    var input = block.querySelector(&#39;input&#39;);
    return input ? Number(input.value) : null;
}

function blockUnits(block){
    if (block.children.length &gt; 1 &amp;&amp;
        block.lastChild.nodeType === Node.TEXT_NODE &amp;&amp;
        block.lastChild.textContent){
        return block.lastChild.textContent.slice(1);
    }
}

function blockScript(block){
    var script = [block.dataset.name];
    var value = blockValue(block);
    if (value !== null){
        script.push(blockValue(block));
    }
    var contents = blockContents(block);
    var units = blockUnits(block);
    if (contents){script.push(contents.map(blockScript));}
    if (units){script.push(units);}
    return script.filter(function(notNull){ return notNull !== null; });
}

function runBlocks(blocks){
    blocks.forEach(function(block){ trigger(&#39;run&#39;, block); });
}
</pre></div>
</div>
<p class="rubric" id="drag-js"><code class="docutils literal"><span class="pre">drag.js</span></code></p>
<p>The purpose of <code class="docutils literal"><span class="pre">drag.js</span></code> is to turn static blocks of HTML into a
dynamic programming language by implementing interactions between the
menu section of the view and the script section. The user builds their
program by dragging blocks from the menu into the script, and the system
runs the blocks in the script area.</p>
<p>We're using HTML5 drag-and-drop; the specific JavaScript event handlers
it requires are defined here. (For more information on using HTML5
drag-and-drop, see <a class="reference external" href="http://www.html5rocks.com/en/tutorials/dnd/basics/">Eric Bidleman's article</a>.) While it is nice to have
built-in support for drag-and-drop, it does have some oddities and some
pretty major limitations, like not being implemented in any mobile
browser at the time of this writing.</p>
<p>We define some variables at the top of the file. When we're dragging,
we'll need to reference these from different stages of the dragging
callback dance.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>var dragTarget = null; // Block we&#39;re dragging
var dragType = null; // Are we dragging from the menu or from the script?
var scriptBlocks = []; // Blocks in the script, sorted by position
</pre></div>
</div>
<p>Depending on where the drag starts and ends, <code class="docutils literal"><span class="pre">drop</span></code> will have
different effects:</p>
<ul class="simple">
<li>If dragging from script to menu, delete <code class="docutils literal"><span class="pre">dragTarget</span></code> (remove block
from script).</li>
<li>If dragging from script to script, move <code class="docutils literal"><span class="pre">dragTarget</span></code> (move an
existing script block).</li>
<li>If dragging from menu to script, copy <code class="docutils literal"><span class="pre">dragTarget</span></code> (insert new
block in script).</li>
<li>If dragging from menu to menu, do nothing.</li>
</ul>
<p>During the <code class="docutils literal"><span class="pre">dragStart(evt)</span></code> handler we start tracking whether the
block is being copied from the menu or moved from (or within) the
script. We also grab a list of all the blocks in the script which are
not being dragged, to use later. The <code class="docutils literal"><span class="pre">evt.dataTransfer.setData</span></code> call
is used for dragging between the browser and other applications (or the
desktop), which we're not using, but have to call anyway to work around
a bug.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>function dragStart(evt){
    if (!matches(evt.target, &#39;.block&#39;)) return;
    if (matches(evt.target, &#39;.menu .block&#39;)){
        dragType = &#39;menu&#39;;
    }else{
        dragType = &#39;script&#39;;
    }
    evt.target.classList.add(&#39;dragging&#39;);
    dragTarget = evt.target;
    scriptBlocks = [].slice.call(
        document.querySelectorAll(&#39;.script .block:not(.dragging)&#39;));
    // For dragging to take place in Firefox, we have to set this, even if
    // we don&#39;t use it
    evt.dataTransfer.setData(&#39;text/html&#39;, evt.target.outerHTML);
    if (matches(evt.target, &#39;.menu .block&#39;)){
        evt.dataTransfer.effectAllowed = &#39;copy&#39;;
    }else{
        evt.dataTransfer.effectAllowed = &#39;move&#39;;
    }
}
</pre></div>
</div>
<p>While we are dragging, the <code class="docutils literal"><span class="pre">dragenter</span></code>, <code class="docutils literal"><span class="pre">dragover</span></code>, and <code class="docutils literal"><span class="pre">dragout</span></code>
events give us opportunities to add visual cues by highlighting valid
drop targets, etc. Of these, we only make use of <code class="docutils literal"><span class="pre">dragover</span></code>.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>function dragOver(evt){
    if (!matches(evt.target, &#39;.menu, .menu *, .script, .script *, .content&#39;)) {
        return;
    }
    // Necessary. Allows us to drop.
    if (evt.preventDefault) { evt.preventDefault(); }
    if (dragType === &#39;menu&#39;){
        // See the section on the DataTransfer object.
        evt.dataTransfer.dropEffect = &#39;copy&#39;;
    }else{
        evt.dataTransfer.dropEffect = &#39;move&#39;;
    }
    return false;
}
</pre></div>
</div>
<p>When we release the mouse, we get a <code class="docutils literal"><span class="pre">drop</span></code> event. This is where the
magic happens. We have to check where we dragged from (set back in
<code class="docutils literal"><span class="pre">dragStart</span></code>) and where we have dragged to. Then we either copy the
block, move the block, or delete the block as needed. We fire off some
custom events using <code class="docutils literal"><span class="pre">trigger()</span></code> (defined in <code class="docutils literal"><span class="pre">util.js</span></code>) for our own
use in the block logic, so we can refresh the script when it changes.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>function drop(evt){
    if (!matches(evt.target, &#39;.menu, .menu *, .script, .script *&#39;)) return;
    var dropTarget = closest(
        evt.target, &#39;.script .container, .script .block, .menu, .script&#39;);
    var dropType = &#39;script&#39;;
    if (matches(dropTarget, &#39;.menu&#39;)){ dropType = &#39;menu&#39;; }
    // stops the browser from redirecting.
    if (evt.stopPropagation) { evt.stopPropagation(); }
    if (dragType === &#39;script&#39; &amp;&amp; dropType === &#39;menu&#39;){
        trigger(&#39;blockRemoved&#39;, dragTarget.parentElement, dragTarget);
        dragTarget.parentElement.removeChild(dragTarget);
    }else if (dragType ===&#39;script&#39; &amp;&amp; dropType === &#39;script&#39;){
        if (matches(dropTarget, &#39;.block&#39;)){
            dropTarget.parentElement.insertBefore(
                dragTarget, dropTarget.nextSibling);
        }else{
            dropTarget.insertBefore(dragTarget, dropTarget.firstChildElement);
        }
        trigger(&#39;blockMoved&#39;, dropTarget, dragTarget);
    }else if (dragType === &#39;menu&#39; &amp;&amp; dropType === &#39;script&#39;){
        var newNode = dragTarget.cloneNode(true);
        newNode.classList.remove(&#39;dragging&#39;);
        if (matches(dropTarget, &#39;.block&#39;)){
            dropTarget.parentElement.insertBefore(
                newNode, dropTarget.nextSibling);
        }else{
            dropTarget.insertBefore(newNode, dropTarget.firstChildElement);
        }
        trigger(&#39;blockAdded&#39;, dropTarget, newNode);
    }
}
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">dragEnd(evt)</span></code> is called when we mouse up, but after we handle the
<code class="docutils literal"><span class="pre">drop</span></code> event. This is where we can clean up, remove classes from
elements, and reset things for the next drag.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">_findAndRemoveClass</span><span class="p">(</span><span class="n">klass</span><span class="p">){</span>
    <span class="n">var</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">klass</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="p">){</span> <span class="n">elem</span><span class="o">.</span><span class="n">classList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>

<span class="n">function</span> <span class="n">dragEnd</span><span class="p">(</span><span class="n">evt</span><span class="p">){</span>
    <span class="n">_findAndRemoveClass</span><span class="p">(</span><span class="s1">&#39;dragging&#39;</span><span class="p">);</span>
    <span class="n">_findAndRemoveClass</span><span class="p">(</span><span class="s1">&#39;over&#39;</span><span class="p">);</span>
    <span class="n">_findAndRemoveClass</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric" id="menu-js"><code class="docutils literal"><span class="pre">menu.js</span></code></p>
<p>The file <code class="docutils literal"><span class="pre">menu.js</span></code> is where blocks are associated with the functions
that are called when they run, and contains the code for actually
running the script as the user builds it up. Every time the script is
modified, it is re-run automatically.</p>
<p>&quot;Menu&quot; in this context is not a drop-down (or pop-up) menu, like in most
applications, but is the list of blocks you can choose for your script.
This file sets that up, and starts the menu off with a looping block
that is generally useful (and thus not part of the turtle language
itself). This is kind of an odds-and-ends file, for things that may not
fit anywhere else.</p>
<p>Having a single file to gather random functions in is useful, especially
when an architecture is under development. My theory of keeping a clean
house is to have designated places for clutter, and that applies to
building a program architecture too. One file or module becomes the
catch-all for things that don't have a clear place to fit in yet. As
this file grows it is important to watch for emerging patterns: several
related functions can be spun off into a separate module (or joined
together into a more general function). You don't want the catch-all to
grow indefinitely, but only to be a temporary holding place until you
figure out the right way to organize the code.</p>
<p>We keep around references to <code class="docutils literal"><span class="pre">menu</span></code> and <code class="docutils literal"><span class="pre">script</span></code> because we use them
a lot; no point hunting through the DOM for them over and over. We'll
also use <code class="docutils literal"><span class="pre">scriptRegistry</span></code>, where we store the scripts of blocks in the
menu. We use a very simple name-to-script mapping which does not support
either multiple menu blocks with the same name or renaming blocks. A
more complex scripting environment would need something more robust.</p>
<p>We use <code class="docutils literal"><span class="pre">scriptDirty</span></code> to keep track of whether the script has been
modified since the last time it was run, so we don't keep trying to run
it constantly.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;.menu&#39;</span><span class="p">);</span>
<span class="n">var</span> <span class="n">script</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;.script&#39;</span><span class="p">);</span>
<span class="n">var</span> <span class="n">scriptRegistry</span> <span class="o">=</span> <span class="p">{};</span>
<span class="n">var</span> <span class="n">scriptDirty</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
</pre></div>
</div>
<p>When we want to notify the system to run the script during the next
frame handler, we call <code class="docutils literal"><span class="pre">runSoon()</span></code> which sets the <code class="docutils literal"><span class="pre">scriptDirty</span></code> flag
to <code class="docutils literal"><span class="pre">true</span></code>. The system calls <code class="docutils literal"><span class="pre">run()</span></code> on every frame, but returns
immediately unless <code class="docutils literal"><span class="pre">scriptDirty</span></code> is set. When <code class="docutils literal"><span class="pre">scriptDirty</span></code> is set,
it runs all the script blocks, and also triggers events to let the
specific language handle any tasks it needs before and after the script
is run. This decouples the blocks-as-toolkit from the turtle language to
make the blocks re-usable (or the language pluggable, depending how you
look at it).</p>
<p>As part of running the script, we iterate over each block, calling
<code class="docutils literal"><span class="pre">runEach(evt)</span></code> on it, which sets a class on the block, then finds and
executes its associated function. If we slow things down, you should be
able to watch the code execute as each block highlights to show when it
is running.</p>
<p>The <code class="docutils literal"><span class="pre">requestAnimationFrame</span></code> method below is provided by the browser
for animation. It takes a function which will be called for the next
frame to be rendered by the browser (at 60 frames per second) after the
call is made. How many frames we actually get depends on how fast we can
get work done in that call.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>function runSoon(){ scriptDirty = true; }

function run(){
    if (scriptDirty){
        scriptDirty = false;
        Block.trigger(&#39;beforeRun&#39;, script);
        var blocks = [].slice.call(
            document.querySelectorAll(&#39;.script &gt; .block&#39;));
        Block.run(blocks);
        Block.trigger(&#39;afterRun&#39;, script);
    }else{
        Block.trigger(&#39;everyFrame&#39;, script);
    }
    requestAnimationFrame(run);
}
requestAnimationFrame(run);

function runEach(evt){
    var elem = evt.target;
    if (!matches(elem, &#39;.script .block&#39;)) return;
    if (elem.dataset.name === &#39;Define block&#39;) return;
    elem.classList.add(&#39;running&#39;);
    scriptRegistry[elem.dataset.name](elem);
    elem.classList.remove(&#39;running&#39;);
}
</pre></div>
</div>
<p>We add blocks to the menu using <code class="docutils literal"><span class="pre">menuItem(name,</span> <span class="pre">fn,</span> <span class="pre">value,</span> <span class="pre">contents)</span></code>
which takes a normal block, associates it with a function, and puts in
the menu column.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">menuItem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="p">){</span>
    <span class="n">var</span> <span class="n">item</span> <span class="o">=</span> <span class="n">Block</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="p">);</span>
    <span class="n">scriptRegistry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
    <span class="n">menu</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">item</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We define <code class="docutils literal"><span class="pre">repeat(block)</span></code> here, outside of the turtle language,
because it is generally useful in different languages. If we had blocks
for conditionals and reading and writing variables they could also go
here, or into a separate trans-language module, but right now we only
have one of these general-purpose blocks defined.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">repeat</span><span class="p">(</span><span class="n">block</span><span class="p">){</span>
    <span class="n">var</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Block</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
    <span class="n">var</span> <span class="n">children</span> <span class="o">=</span> <span class="n">Block</span><span class="o">.</span><span class="n">contents</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">Block</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">children</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">menuItem</span><span class="p">(</span><span class="s1">&#39;Repeat&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">[]);</span>
</pre></div>
</div>
<p class="rubric" id="turtle-js"><code class="docutils literal"><span class="pre">turtle.js</span></code></p>
<p><code class="docutils literal"><span class="pre">turtle.js</span></code> is the implementation of the turtle block language. It
exposes no functions to the rest of the code, so nothing else can depend
on it. This way we can swap out the one file to create a new block
language and know nothing in the core will break.</p>
<div class="center figure"><p><img alt="Figure 1.3 - Example of Turtle code running" src="chapters/blockcode-images/turtle_example.png" /></p>
</div><p>Figure 1.3 - Example of Turtle code running</p>
<p>Turtle programming is a style of graphics programming, first popularized
by Logo, where you have an imaginary turtle carrying a pen walking on
the screen. You can tell the turtle to pick up the pen (stop drawing,
but still move), put the pen down (leaving a line everywhere it goes),
move forward a number of steps, or turn a number of degrees. Just those
commands, combined with looping, can create amazingly intricate images.</p>
<p>In this version of turtle graphics we have a few extra blocks.
Technically we don't need both <code class="docutils literal"><span class="pre">turn</span> <span class="pre">right</span></code> and <code class="docutils literal"><span class="pre">turn</span> <span class="pre">left</span></code> because
you can have one and get the other with negative numbers. Likewise
<code class="docutils literal"><span class="pre">move</span> <span class="pre">back</span></code> can be done with <code class="docutils literal"><span class="pre">move</span> <span class="pre">forward</span></code> and negative numbers. In
this case it felt more balanced to have both.</p>
<p>The image above was formed by putting two loops inside another loop and
adding a <code class="docutils literal"><span class="pre">move</span> <span class="pre">forward</span></code> and <code class="docutils literal"><span class="pre">turn</span> <span class="pre">right</span></code> to each loop, then playing
with the parameters interactively until I liked the image that resulted.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">PIXEL_RATIO</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">devicePixelRatio</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">var</span> <span class="n">canvasPlaceholder</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;.canvas-placeholder&#39;</span><span class="p">);</span>
<span class="n">var</span> <span class="n">canvas</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;.canvas&#39;</span><span class="p">);</span>
<span class="n">var</span> <span class="n">script</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;.script&#39;</span><span class="p">);</span>
<span class="n">var</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
<span class="n">var</span> <span class="n">cos</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="n">sqrt</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">PI</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">PI</span><span class="p">;</span>
<span class="n">var</span> <span class="n">DEGREE</span> <span class="o">=</span> <span class="n">PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">;</span>
<span class="n">var</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">visible</span><span class="p">,</span> <span class="n">pen</span><span class="p">,</span> <span class="n">color</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">reset()</span></code> function clears all the state variables to their
defaults. If we were to support multiple turtles, these variables would
be encapsulated in an object. We also have a utility, <code class="docutils literal"><span class="pre">deg2rad(deg)</span></code>,
because we work in degrees in the UI, but we draw in radians. Finally,
<code class="docutils literal"><span class="pre">drawTurtle()</span></code> draws the turtle itself. The default turtle is simply a
triangle, but you could override this to draw a more
aesthetically-pleasing turtle.</p>
<p>Note that <code class="docutils literal"><span class="pre">drawTurtle</span></code> uses the same primitive operations that we
define to implement the turtle drawing. Sometimes you don't want to
reuse code at different abstraction layers, but when the meaning is
clear it can be a big win for code size and performance.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">reset</span><span class="p">(){</span>
    <span class="n">recenter</span><span class="p">();</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">deg2rad</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span> <span class="o">//</span> <span class="n">facing</span> <span class="s2">&quot;up&quot;</span>
    <span class="n">visible</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
    <span class="n">pen</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span> <span class="o">//</span> <span class="n">when</span> <span class="n">pen</span> <span class="ow">is</span> <span class="n">true</span> <span class="n">we</span> <span class="n">draw</span><span class="p">,</span> <span class="n">otherwise</span> <span class="n">we</span> <span class="n">move</span> <span class="n">without</span> <span class="n">drawing</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">function</span> <span class="n">deg2rad</span><span class="p">(</span><span class="n">degrees</span><span class="p">){</span> <span class="k">return</span> <span class="n">DEGREE</span> <span class="o">*</span> <span class="n">degrees</span><span class="p">;</span> <span class="p">}</span>

<span class="n">function</span> <span class="n">drawTurtle</span><span class="p">(){</span>
    <span class="n">var</span> <span class="n">userPen</span> <span class="o">=</span> <span class="n">pen</span><span class="p">;</span> <span class="o">//</span> <span class="n">save</span> <span class="n">pen</span> <span class="n">state</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">visible</span><span class="p">){</span>
        <span class="n">penUp</span><span class="p">();</span> <span class="n">_moveForward</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">penDown</span><span class="p">();</span>
        <span class="n">_turn</span><span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">);</span> <span class="n">_moveForward</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
        <span class="n">_turn</span><span class="p">(</span><span class="o">-</span><span class="mi">120</span><span class="p">);</span> <span class="n">_moveForward</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
        <span class="n">_turn</span><span class="p">(</span><span class="o">-</span><span class="mi">120</span><span class="p">);</span> <span class="n">_moveForward</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
        <span class="n">_turn</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
        <span class="n">penUp</span><span class="p">();</span> <span class="n">_moveForward</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">userPen</span><span class="p">){</span>
            <span class="n">penDown</span><span class="p">();</span> <span class="o">//</span> <span class="n">restore</span> <span class="n">pen</span> <span class="n">state</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We have a special block to draw a circle with a given radius at the
current mouse position. We special-case <code class="docutils literal"><span class="pre">drawCircle</span></code> because, while
you can certainly draw a circle by repeating <code class="docutils literal"><span class="pre">MOVE</span> <span class="pre">1</span> <span class="pre">RIGHT</span> <span class="pre">1</span></code> 360
times, controlling the size of the circle is very difficult that way.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">drawCircle</span><span class="p">(</span><span class="n">radius</span><span class="p">){</span>
    <span class="o">//</span> <span class="n">Math</span> <span class="k">for</span> <span class="n">this</span> <span class="ow">is</span> <span class="kn">from</span> <span class="nn">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">mathopenref</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">polygonradius</span><span class="o">.</span><span class="n">html</span>
    <span class="n">var</span> <span class="n">userPen</span> <span class="o">=</span> <span class="n">pen</span><span class="p">;</span> <span class="o">//</span> <span class="n">save</span> <span class="n">pen</span> <span class="n">state</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">visible</span><span class="p">){</span>
        <span class="n">penUp</span><span class="p">();</span> <span class="n">_moveForward</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">);</span> <span class="n">penDown</span><span class="p">();</span>
        <span class="n">_turn</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">);</span>
        <span class="n">var</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">Math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span> <span class="mi">360</span><span class="p">);</span>
        <span class="n">var</span> <span class="n">theta</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">steps</span><span class="p">;</span>
        <span class="n">var</span> <span class="n">side</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">PI</span> <span class="o">/</span> <span class="n">steps</span><span class="p">);</span>
        <span class="n">_moveForward</span><span class="p">(</span><span class="n">side</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">steps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="n">_turn</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span> <span class="n">_moveForward</span><span class="p">(</span><span class="n">side</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">_turn</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span> <span class="n">_moveForward</span><span class="p">(</span><span class="n">side</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">_turn</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>
        <span class="n">penUp</span><span class="p">();</span> <span class="n">_moveForward</span><span class="p">(</span><span class="n">radius</span><span class="p">);</span> <span class="n">penDown</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">userPen</span><span class="p">){</span>
            <span class="n">penDown</span><span class="p">();</span> <span class="o">//</span> <span class="n">restore</span> <span class="n">pen</span> <span class="n">state</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Our main primitive is <code class="docutils literal"><span class="pre">moveForward</span></code>, which has to handle some
elementary trigonometry and check whether the pen is up or down.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">_moveForward</span><span class="p">(</span><span class="n">distance</span><span class="p">){</span>
    <span class="n">var</span> <span class="n">start</span> <span class="o">=</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">position</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">cos</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">PIXEL_RATIO</span> <span class="o">+</span> <span class="n">start</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">PIXEL_RATIO</span> <span class="o">+</span> <span class="n">start</span><span class="o">.</span><span class="n">y</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pen</span><span class="p">){</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">lineStyle</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">beginPath</span><span class="p">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">moveTo</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">lineTo</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">stroke</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Most of the rest of the turtle commands can be easily defined in terms
of what we've built above.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">penUp</span><span class="p">(){</span> <span class="n">pen</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">penDown</span><span class="p">(){</span> <span class="n">pen</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">hideTurtle</span><span class="p">(){</span> <span class="n">visible</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">showTurtle</span><span class="p">(){</span> <span class="n">visible</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">forward</span><span class="p">(</span><span class="n">block</span><span class="p">){</span> <span class="n">_moveForward</span><span class="p">(</span><span class="n">Block</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">block</span><span class="p">));</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">back</span><span class="p">(</span><span class="n">block</span><span class="p">){</span> <span class="n">_moveForward</span><span class="p">(</span><span class="o">-</span><span class="n">Block</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">block</span><span class="p">));</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">circle</span><span class="p">(</span><span class="n">block</span><span class="p">){</span> <span class="n">drawCircle</span><span class="p">(</span><span class="n">Block</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">block</span><span class="p">));</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">_turn</span><span class="p">(</span><span class="n">degrees</span><span class="p">){</span> <span class="n">direction</span> <span class="o">+=</span> <span class="n">deg2rad</span><span class="p">(</span><span class="n">degrees</span><span class="p">);</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">left</span><span class="p">(</span><span class="n">block</span><span class="p">){</span> <span class="n">_turn</span><span class="p">(</span><span class="n">Block</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">block</span><span class="p">));</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">right</span><span class="p">(</span><span class="n">block</span><span class="p">){</span> <span class="n">_turn</span><span class="p">(</span><span class="o">-</span><span class="n">Block</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">block</span><span class="p">));</span> <span class="p">}</span>
<span class="n">function</span> <span class="n">recenter</span><span class="p">(){</span> <span class="n">position</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">WIDTH</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">HEIGHT</span><span class="o">/</span><span class="mi">2</span><span class="p">};</span> <span class="p">}</span>
</pre></div>
</div>
<p>When we want a fresh slate, the <code class="docutils literal"><span class="pre">clear</span></code> function restores everything
back to where we started.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">clear</span><span class="p">(){</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">save</span><span class="p">();</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">fillStyle</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">WIDTH</span><span class="p">,</span><span class="n">HEIGHT</span><span class="p">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">restore</span><span class="p">();</span>
    <span class="n">reset</span><span class="p">();</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">moveTo</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When this script first loads and runs, we use our <code class="docutils literal"><span class="pre">reset</span></code> and
<code class="docutils literal"><span class="pre">clear</span></code> to initialize everything and draw the turtle.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">onResize</span><span class="p">();</span>
<span class="n">clear</span><span class="p">();</span>
<span class="n">drawTurtle</span><span class="p">();</span>
</pre></div>
</div>
<p>Now we can use the functions above, with the <code class="docutils literal"><span class="pre">Menu.item</span></code> function from
<code class="docutils literal"><span class="pre">menu.js</span></code>, to make blocks for the user to build scripts from. These
are dragged into place to make the user's programs.</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Left&#39;</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Right&#39;</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Forward&#39;</span><span class="p">,</span> <span class="n">forward</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Back&#39;</span><span class="p">,</span> <span class="n">back</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Circle&#39;</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Pen up&#39;</span><span class="p">,</span> <span class="n">penUp</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Pen down&#39;</span><span class="p">,</span> <span class="n">penDown</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Back to center&#39;</span><span class="p">,</span> <span class="n">recenter</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Hide turtle&#39;</span><span class="p">,</span> <span class="n">hideTurtle</span><span class="p">);</span>
<span class="n">Menu</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="s1">&#39;Show turtle&#39;</span><span class="p">,</span> <span class="n">showTurtle</span><span class="p">);</span>
</pre></div>
</div>
<p class="rubric" id="lessons-learned">Lessons Learned</p>
<p class="rubric" id="why-not-use-mvc">Why Not Use MVC?</p>
<p>Model-View-Controller (MVC) was a good design choice for Smalltalk
programs in the '80s and it can work in some variation or other for web
apps, but it isn't the right tool for every problem. All the state (the
&quot;model&quot; in MVC) is captured by the block elements in a block language
anyway, so replicating it into Javascript has little benefit unless
there is some other need for the model (if we were editing shared,
distributed code, for instance).</p>
<p>An early version of Waterbear went to great lengths to keep the model in
JavaScript and sync it with the DOM, until I noticed that more than half
the code and 90% of the bugs were due to keeping the model in sync with
the DOM. Eliminating the duplication allowed the code to be simpler and
more robust, and with all the state on the DOM elements, many bugs could
be found simply by looking at the DOM in the developer tools. So in this
case there is little benefit to building further separation of MVC than
we already have in HTML/CSS/JavaScript.</p>
<p class="rubric" id="toy-changes-can-lead-to-real-changes">Toy Changes Can Lead to Real Changes</p>
<p>Building a small, tightly scoped version of the larger system I work on
has been an interesting exercise. Sometimes in a large system there are
things you are hesitant to change because they affect too many other
things. In a tiny, toy version you can experiment freely and learn
things which you can then take back to the larger system. For me, the
larger system is Waterbear and this project has had a huge impact on the
way Waterbear is structured.</p>
<p class="rubric" id="small-experiments-make-failure-ok">Small Experiments Make Failure OK</p>
<p>Some of the experiments I was able to do with this stripped-down block
language were:</p>
<ul class="simple">
<li>using HTML5 drag-and-drop,</li>
<li>running blocks directly by iterating through the DOM calling
associated functions,</li>
<li>separating the code that runs cleanly from the HTML DOM,</li>
<li>simplified hit testing while dragging,</li>
<li>building our own tiny vector and sprite libraries (for the game
blocks), and</li>
<li>&quot;live coding&quot; where the results are shown whenever you change the
block script.</li>
</ul>
<p>The thing about experiments is that they do not have to succeed. We tend
to gloss over failures and dead ends in our work, where failures are
punished instead of treated as important vehicles for learning, but
failures are essential if you are going to push forward. While I did get
the HTML5 drag-and-drop working, the fact that it isn't supported at all
on any mobile browser means it is a non-starter for Waterbear.
Separating the code out and running code by iterating through the blocks
worked so well that I've already begun bringing those ideas to
Waterbear, with excellent improvements in testing and debugging. The
simplified hit testing, with some modifications, is also coming back to
Waterbear, as are the tiny vector and sprite libraries. Live coding
hasn't made it to Waterbear yet, but once the current round of changes
stabilizes I may introduce it.</p>
<p class="rubric" id="what-are-we-trying-to-build-really">What Are We Trying to Build, Really?</p>
<p>Building a small version of a bigger system puts a sharp focus on what
the important parts really are. Are there bits left in for historical
reasons that serve no purpose (or worse, distract from the purpose)? Are
there features no-one uses but you have to pay to maintain? Could the
user interface be streamlined? All these are great questions to ask
while making a tiny version. Drastic changes, like re-organizing the
layout, can be made without worrying about the ramifications cascading
through a more complex system, and can even guide refactoring the
complex system.</p>
<p class="rubric" id="a-program-is-a-process-not-a-thing">A Program is a Process, Not a Thing</p>
<p>There are things I wasn't able to experiment with in the scope of this
project that I may use the blockcode codebase to test out in the future.
It would be interesting to create &quot;function&quot; blocks which create new
blocks out of existing blocks. Implementing undo/redo would be simpler
in a constrained environment. Making blocks accept multiple arguments
without radically expanding the complexity would be useful. And finding
various ways to share block scripts online would bring the webbiness of
the tool full circle.</p>
</div></div></div></div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Learn-Computer-and-Math-again</a></h1>








<h3>导航</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">500 Lines or Less | Blockcode: A visual programming toolkit</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../index.html" title="上一章">Welcome to Learn-Computer-and-Math-again's documentation!</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, timger.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/chapters/blockcode-a-visual-programming-toolkit.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>