
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>500 Lines or Less | A Pedometer in the Real World &#8212; Learn-Computer-and-Math-again 0.0.1 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="lines-or-less-a-pedometer-in-the-real-world">
<h1>500 Lines or Less | A Pedometer in the Real World<a class="headerlink" href="#lines-or-less-a-pedometer-in-the-real-world" title="永久链接至标题">¶</a></h1>
<div class="container"><div class="row"><div class="hero-unit"><p><a href="#id1"><span class="problematic" id="id2">``</span></a>_
.. rubric:: A Pedometer in the Real World</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">name:</th><td class="field-body">a-pedometer-in-the-real-world</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="author rubric" id="dessy-daskalov">Dessy Daskalov</p>
</div></div><div class="row"><div id="content" class="span10 offset1"><p><em>Dessy is an engineer by trade, an entrepreneur by passion, and a
developer at heart. She's currently the CTO and co-founder of `Nudge
Rewards`_ When she’s not busy building product with her team, she can be
found teaching others to code, attending or hosting a Toronto tech
event, and online at `dessydaskalov.com`_ and `&#64;dess_e`_.</em></p>
<p class="rubric" id="a-perfect-world">A Perfect World</p>
<p>Many software engineers reflecting on their training will remember
having the pleasure of living in a very perfect world. We were taught to
solve well-defined problems in idealized domains.</p>
<p>Then we were thrown into the real world, with all of its complexities
and challenges. It's messy, which makes it all the more exciting. When
you can solve a real-life problem, with all of its quirks, you can build
software that really helps people.</p>
<p>In this chapter, we'll examine a problem that looks straightforward on
the surface, and gets tangled very quickly when the real world, and real
people, are thrown into the mix.</p>
<p>We'll work together to build a basic pedometer. We'll start by
discussing the theory behind a pedometer and creating a step counting
solution outside of code. Then, we'll implement our solution in code.
Finally, we'll add a web layer to our code so that we have a friendly
interface for a user to work with.</p>
<p>Let's roll up our sleeves, and prepare to untangle a real-world problem.</p>
<p class="rubric" id="pedometer-theory">Pedometer Theory</p>
<p>The rise of the mobile device brought with it a trend to collect more
and more data on our daily lives. One type of data many people collect
is the number of steps they've taken over a period of time. This data
can be used for health tracking, training for sporting events, or, for
those of us obsessed with collecting and analyzing data, just for kicks.
Steps can be counted using a pedometer, which often uses data from a
hardware accelerometer as input.</p>
<p class="rubric" id="whats-an-accelerometer">What's an Accelerometer?</p>
<p>An accelerometer is a piece of hardware that measures acceleration in
the \(x\), \(y\), and \(z\) directions. Many people carry an
accelerometer with them wherever they go, as it's built into almost all
smartphones currently on the market. The \(x\), \(y\), and \(z\)
directions are relative to the phone.</p>
<p>An accelerometer returns a <em>signal</em> in 3-dimensional space. A signal is
a set of data points recorded over time. Each component of the signal is
a time series representing acceleration in one of the \(x\), \(y\),
or \(z\) directions. Each point in a time series is the acceleration
in that direction at a specific point in time. Acceleration is measured
in units of g-force, or <em>g</em>. One <em>g</em> is equal to 9.8 \(m/s^2\), the
average acceleration due to gravity on Earth.</p>
<p><a class="reference external" href="#figure-16.1">Figure 16.1</a> shows an example signal from an accelerometer with the
three time series.</p>
<div class="center figure"><p><img alt="Figure 16.1 - Example acceleration signal" src="chapters/pedometer-images/acceleration-total.png" /></p>
</div><p>Figure 16.1 - Example acceleration signal</p>
<p>The <em>sampling rate</em> of the accelerometer, which can often be calibrated,
determines the number of measurements per second. For instance, an
accelerometer with a sampling rate of 100 returns 100 data points for
each \(x\), \(y\), and \(z\) time series every second.</p>
<p class="rubric" id="lets-talk-about-a-walk">Let's Talk About a Walk</p>
<p>When a person walks, they bounce slightly with each step. Just watch the
top of a person's head as they walk away from you. Their head, torso,
and hips are synchronized in a smooth bouncing motion. While people
don't bounce very far, only one or two centimeters, it is one of the
clearest, most constant, and most recognizable parts of a person's
walking acceleration signal.</p>
<p>A person bounces up and down, in the vertical direction, with each step.
If you are walking on Earth (or another big ball of mass floating in
space) the bounce is conveniently in the same direction as gravity.</p>
<p>We are going to count steps by using the accelerometer to count bounces
up and down. Because the phone can rotate in any direction, we will use
gravity to know which direction down is. <strong>A pedometer can count steps
by counting the number of bounces in the direction of gravity.</strong></p>
<p>Let's look at a person walking with an accelerometer-equipped smartphone
in his or her shirt pocket (<a class="reference external" href="#figure-16.2">Figure 16.2</a>).</p>
<div class="center figure"><p><img alt="Figure 16.2 - Walking" src="chapters/pedometer-images/walk-1.png" /></p>
</div><p>Figure 16.2 - Walking</p>
<p>For the sake of simplicity, we'll assume that the person:</p>
<ul class="simple">
<li>is walking in the \(z\) direction;</li>
<li>bounces with each step in the \(y\) direction; and</li>
<li>maintains the phone in the same orientation throughout the entire
walk.</li>
</ul>
<p>In our perfect world, acceleration from step bounces will form a perfect
sine wave in the \(y\) direction. Each peak in the sine wave is
exactly one step. Step counting becomes a matter of counting these
perfect peaks.</p>
<p>Ah, the joys of a perfect world, which we only ever experience in texts
like this. Don't fret, things are about to get a little messier, and a
lot more exciting. Let's add a little more reality to our world.</p>
<p class="rubric" id="even-perfect-worlds-have-fundamental-forces-of-nature">Even Perfect Worlds Have Fundamental Forces of Nature</p>
<p>The force of gravity causes an acceleration in the direction of gravity,
which we refer to as gravitational acceleration. This acceleration is
unique because it is always present and, for the purposes of this
chapter, is constant at 9.8 \(m/s^2\).</p>
<p>Suppose a smartphone is lying on a table screen-side up. In this
orientation, our coordinate system is such that the negative \(z\)
direction is the one that gravity is acting on. Gravity will pull our
phone in the negative \(z\) direction, so our accelerometer, <em>even
when perfectly still</em>, will record an acceleration of 9.8 \(m/s^2\) in
the negative \(z\) direction. Accelerometer data from our phone in
this orientation is shown in <a class="reference external" href="#figure-16.3">Figure 16.3</a>.</p>
<div class="center figure"><p><img alt="Figure 16.3 - Example accelerometer data at rest" src="chapters/pedometer-images/acceleration-total-phone-still.png" /></p>
</div><p>Figure 16.3 - Example accelerometer data at rest</p>
<p>Note that \(x(t)\) and \(y(t)\) remain constant at 0, while
\(z(t)\) is constant at -1 <em>g</em>. Our accelerometer records all
acceleration, including gravitational acceleration.</p>
<p>Each time series measures the <em>total acceleration</em> in that direction.
Total acceleration is the sum of <em>user acceleration</em> and <em>gravitational
acceleration</em>.</p>
<p>User acceleration is the acceleration of the device due to the movement
of the user, and is constant at 0 when the phone is perfectly still.
However, when the user is moving with the device, user acceleration is
rarely constant, since it's difficult for a person to move with a
constant acceleration.</p>
<div class="center figure"><p><img alt="Figure 16.4 - Component signals" src="chapters/pedometer-images/component-signals-2.png" /></p>
</div><p>Figure 16.4 - Component signals</p>
<p>To count steps, we're interested in the bounces created by the user in
the direction of gravity. That means we're interested in isolating the
1-dimensional time series which describes <strong>user acceleration in the
direction of gravity</strong> from our 3-dimensional acceleration signal
(<a class="reference external" href="#figure-16.4">Figure 16.4</a>).</p>
<p>In our simple example, gravitational acceleration is 0 in \(x(t)\) and
\(z(t)\) and constant at 9.8 \(m/s^2\) in \(y(t)\). Therefore, in
our total acceleration plot, \(x(t)\) and \(z(t)\) fluctuate around
0 while \(y(t)\) fluctuates around -1 <em>g</em>. In our user acceleration
plot, we notice that—because we have removed gravitational
acceleration—all three time series fluctuate around 0. Note the obvious
peaks in \(y_{u}(t)\). Those are due to step bounces! In our last
plot, gravitational acceleration, \(y_{g}(t)\) is constant at -1 <em>g</em>,
and \(x_{g}(t)\) and \(z_{g}(t)\) are constant at 0.</p>
<p>So, in our example, the 1-dimensional user acceleration in the direction
of gravity time series we're interested in is \(y_{u}(t)\). Although
\(y_{u}(t)\) isn't as smooth as our perfect sine wave, we can
identify the peaks, and use those peaks to count steps. So far, so good.
Now, let's add even more reality to our world.</p>
<p class="rubric" id="people-are-complicated-creatures">People Are Complicated Creatures</p>
<p>What if a person carries the phone in a bag on their shoulder, with the
phone in a more wonky position? To make matters worse, what if the phone
rotates in the bag part way through the walk, as in <a class="reference external" href="#figure-16.5">Figure 16.5</a>?</p>
<div class="center figure"><p><img alt="Figure 16.5 - A more complicated walk" src="chapters/pedometer-images/walk-2.png" /></p>
</div><p>Figure 16.5 - A more complicated walk</p>
<p>Yikes. Now all three of our components have a non-zero gravitational
acceleration, so the user acceleration in the direction of gravity is
now split amongst all three time series. To determine user acceleration
in the direction of gravity, we first have to determine which direction
gravity is acting in. To do this, we have to split total acceleration in
each of the three time series into a user acceleration time series and a
gravitational acceleration time series (<a class="reference external" href="#figure-16.6">Figure 16.6</a>).</p>
<div class="center figure"><p><img alt="Figure 16.6 - More complicated component signals" src="chapters/pedometer-images/component-signals-3.png" /></p>
</div><p>Figure 16.6 - More complicated component signals</p>
<p>Then we can isolate the portion of user acceleration in each component
that is in the direction of gravity, resulting in just the user
acceleration in the direction of gravity time series.</p>
<p>Let's define this as two steps below:</p>
<ol class="arabic simple">
<li>Splitting total acceleration into user acceleration and gravitational
acceleration.</li>
<li>Isolating user acceleration in the direction of gravity.</li>
</ol>
<p>We'll look at each step separately, and put on our mathematician hats.</p>
<p class="rubric" id="splitting-total-acceleration-into-user-acceleration-and-gravitational-acceleration">1. Splitting Total Acceleration Into User Acceleration and
Gravitational Acceleration</p>
<p>We can use a tool called a <em>filter</em> to split a total acceleration time
series into a user acceleration time series and a gravitational
acceleration time series.</p>
<p class="rubric" id="low-pass-and-high-pass-filters">Low-Pass and High-Pass Filters</p>
<p>A filter is a tool used in signal processing to remove an unwanted
component from a signal.</p>
<p>A <em>low-pass filter</em> allows low-frequency signals through, while
attenuating signals higher than a set threshold. Conversely, a
<em>high-pass filter</em> allows high-frequency signals through, while
attenuating signals below a set threshold. Using music as an analogy, a
low-pass filter can eliminate treble, and a high-pass filter can
eliminate bass.</p>
<p>In our situation, the frequency, measured in Hz, indicates how quickly
the acceleration is changing. A constant acceleration has a frequency of
0 Hz, while a non-constant acceleration has a non-zero frequency. This
means that our constant gravitational acceleration is a 0 Hz signal,
while user acceleration is not.</p>
<p>For each component, we can pass total acceleration through a low-pass
filter, and we'll be left with just the gravitational acceleration time
series. Then we can subtract gravitational acceleration from total
acceleration, and we'll have the user acceleration time series (<a class="reference external" href="#figure-16.7">Figure
16.7</a>).</p>
<div class="center figure"><p><img alt="Figure 16.7 - A low-pass filter" src="chapters/pedometer-images/low-pass-filter-a.png" /></p>
</div><p>Figure 16.7 - A low-pass filter</p>
<p>There are numerous varieties of filters. The one we'll use is called an
infinite impulse response (IIR) filter. We've chosen an IIR filter
because of its low overhead and ease of implementation. The IIR filter
we've chosen is implemented using the formula:</p>
<p>\[ output_{i} = \alpha_{0}(input_{i}\beta_{0} +
input_{i-1}\beta_{1} + input_{i-2}\beta_{2} -
output_{i-1}\alpha_{1} - output_{i-2}\alpha_{2}) \]</p>
<p>The design of digital filters is outside of the scope of this chapter,
but a very short teaser discussion is warranted. It's a well-studied,
fascinating topic, with numerous practical applications. A digital
filter can be designed to cancel any frequency or range of frequencies
desired. The \(\alpha\) and \(\beta\) values in the formula are
coefficients, set based on the cutoff frequency, and the range of
frequencies we want to preserve.</p>
<p>We want to cancel all frequencies except for our constant gravitational
acceleration, so we've chosen coefficients that attenuate frequencies
higher than 0.2 Hz. Notice that we've set our threshold slightly higher
than 0 Hz. While gravity does create a true 0 Hz acceleration, our real,
imperfect world has real, imperfect accelerometers, so we're allowing
for a slight margin of error in measurement.</p>
<p class="rubric" id="implementing-a-low-pass-filter">Implementing a Low-Pass Filter</p>
<p>Let's work through a low-pass filter implementation using our earlier
example. We'll split:</p>
<ul class="simple">
<li>\(x(t)\) into \(x_{g}(t)\) and \(x_{u}(t)\),</li>
<li>\(y(t)\) into \(y_{g}(t)\) and \(y_{u}(t)\), and</li>
<li>\(z(t)\) into \(z_{g}(t)\) and \(z_{u}(t)\).</li>
</ul>
<p>We'll initialize the first two values of gravitational acceleration to
0, so that the formula has initial values to work with.</p>
<p>\[x_{g}(0) = x_{g}(1) = y_{g}(0) = y_{g}(1) = z_{g}(0) = z_{g}(1)
= 0\]</p>
<p>Then we'll implement the filter formula for each time series.</p>
<p>\[x_{g}(t) = \alpha_{0}(x(t)\beta_{0} + x(t-1)\beta_{1} +
x(t-2)\beta_{2} - x_{g}(t-1)\alpha_{1} -
x_{g}(t-2)\alpha_{2})\]</p>
<p>\[y_{g}(t) = \alpha_{0}(y(t)\beta_{0} + y(t-1)\beta_{1} +
y(t-2)\beta_{2} - y_{g}(t-1)\alpha_{1} -
y_{g}(t-2)\alpha_{2})\]</p>
<p>\[z_{g}(t) = \alpha_{0}(z(t)\beta_{0} + z(t-1)\beta_{1} +
z(t-2)\beta_{2} - z_{g}(t-1)\alpha_{1} -
z_{g}(t-2)\alpha_{2})\]</p>
<p>The resulting time series after low-pass filtering are in <a class="reference external" href="#figure-16.8">Figure
16.8</a>.</p>
<div class="center figure"><p><img alt="Figure 16.8 - Gravitational acceleration" src="chapters/pedometer-images/acceleration-gravitational.png" /></p>
</div><p>Figure 16.8 - Gravitational acceleration</p>
<p>\(x_{g}(t)\) and \(z_{g}(t)\) hover around 0, and \(y_{g}(t)\)
very quickly drops to \(-1g\). The initial 0 value in \(y_{g}(t)\)
is from the initialization of the formula.</p>
<p>Now, to calculate user acceleration, we can subtract gravitational
acceleration from our total acceleration:</p>
<p>\[ x_{u}(t) = x(t) - x_{g}(t) \] \[ y_{u}(t) = y(t) - y_{g}(t)
\] \[ z_{u}(t) = z(t) - z_{g}(t) \]</p>
<p>The result is the time series seen in <a class="reference external" href="#figure-16.9">Figure 16.9</a>. We've successfully
split our total acceleration into user acceleration and gravitational
acceleration!</p>
<div class="center figure"><p><img alt="Figure 16.9 - Split acceleration" src="chapters/pedometer-images/acceleration-user.png" /></p>
</div><p>Figure 16.9 - Split acceleration</p>
<p class="rubric" id="isolating-user-acceleration-in-the-direction-of-gravity">2. Isolating User Acceleration in the Direction of Gravity</p>
<p>\(x_{u}(t)\), \(y_{u}(t)\), and \(z_{u}(t)\) include all
movements of the user, not just movements in the direction of gravity.
Our goal here is to end up with a 1-dimensional time series representing
user acceleration in the direction of gravity. This will include
portions of user acceleration in each of the directions.</p>
<p>Let's get to it. First, some linear algebra 101. Don't take that
mathematician hat off just yet!</p>
<p class="rubric" id="the-dot-product">The Dot Product</p>
<p>When working with coordinates, you won't get very far before being
introduced to the <em>dot product</em>, one of the fundamental tools used in
comparing the magnitude and direction of \(x\), \(y\), and \(z\)
coordinates.</p>
<p>The dot product takes us from 3-dimensional space to 1-dimensional space
(<a class="reference external" href="#figure-16.10">Figure 16.10</a>). When we take the dot product of the two time series,
user acceleration and gravitational acceleration, both of which are in
3-dimensional space, we'll be left with a single time series in
1-dimensional space representing the portion of user acceleration in the
direction of gravity. We'll arbitrarily call this new time series
\(a(t)\), because, well, every important time series deserves a name.</p>
<div class="center figure"><p><img alt="Figure 16.10 - The dot product" src="chapters/pedometer-images/dot-product-explanation.png" /></p>
</div><p>Figure 16.10 - The dot product</p>
<p class="rubric" id="implementing-the-dot-product">Implementing the Dot Product</p>
<p>We can implement the dot product for our earlier example using the
formula \(a(t) = x_{u}(t)x_{g}(t) + y_{u}(t)y_{g}(t) +
z_{u}(t)z_{g}(t)\), leaving us with \(a(t)\) in 1-dimensional space
(<a class="reference external" href="#figure-16.11">Figure 16.11</a>).</p>
<div class="center figure"><p><img alt="Figure 16.11 - Implementing the dot product" src="chapters/pedometer-images/acceleration-dotproduct.png" /></p>
</div><p>Figure 16.11 - Implementing the dot product</p>
<p>We can now visually pick out where the steps are in \(a(t)\). The dot
product is very powerful, yet beautifully simple.</p>
<p class="rubric" id="solutions-in-the-real-world">Solutions in the Real World</p>
<p>We saw how quickly our seemingly simple problem became more complex when
we threw in the challenges of the real world and real people. However,
we're getting a lot closer to counting steps, and we can see how
\(a(t)\) is starting to resemble our ideal sine wave. But, only
&quot;kinda, sorta&quot; starting to. We still need to make our messy \(a(t)\)
time series smoother. There are four main issues (<a class="reference external" href="#figure-16.12">Figure 16.12</a>) with
\(a(t)\) in its current state. Let's examine each one.</p>
<div class="center figure"><p><img alt="Figure 16.12 - Jumpy, slow, short, bumpy" src="chapters/pedometer-images/jumpy-slow-short-bumpy.png" /></p>
</div><p>Figure 16.12 - Jumpy, slow, short, bumpy</p>
<p class="rubric" id="jumpy-peaks">1. Jumpy Peaks</p>
<p>\(a(t)\) is very &quot;jumpy&quot;, because a phone can jiggle with each step,
adding a high-frequency component to our time series. This jumpiness is
called noise. By studying numerous data sets, we've determined that a
step acceleration is at maximum 5 Hz. We can use a low-pass IIR filter
to remove the noise, picking \(\alpha\) and \(\beta\) to attenuate
all signals above 5 Hz.</p>
<p class="rubric" id="slow-peaks">2. Slow Peaks</p>
<p>With a sampling rate of 100, the slow peak displayed in \(a(t)\) spans
1.5 seconds, which is too slow to be a step. In studying enough samples
of data, we've determined that the slowest step we can take is at a 1 Hz
frequency. Slower accelerations are due to a low-frequency component,
that we can again remove using a high-pass IIR filter, setting
\(\alpha\) and \(\beta\) to cancel all signals below 1 Hz.</p>
<p class="rubric" id="short-peaks">3. Short Peaks</p>
<p>As a person is using an app or making a call, the accelerometer
registers small movements in the direction of gravity, presenting
themselves as short peaks in our time series. We can eliminate these
short peaks by setting a minimum threshold, and counting a step every
time \(a(t)\) crosses that threshold in the positive direction.</p>
<p class="rubric" id="bumpy-peaks">4. Bumpy Peaks</p>
<p>Our pedometer should accommodate many people with different walks, so
we've set minimum and maximum step frequencies based on a large sample
size of people and walks. This means that we may sometimes filter
slightly too much or too little. While we'll often have fairly smooth
peaks, we can, once in a while, get a &quot;bumpier&quot; peak. <a class="reference external" href="#figure-16.12">Figure 16.12</a>
zooms in on one such peak.</p>
<p>When bumpiness occurs at our threshold, we can mistakenly count too many
steps for one peak. We'll use a method called <em>hysteresis</em> to address
this. Hysteresis refers to the dependence of an output on past inputs.
We can count threshold crossings in the positive direction, as well as 0
crossings in the negative direction. Then, we only count steps where a
threshold crossing occurs after a 0 crossing, ensuring we count each
step only once.</p>
<p class="rubric" id="peaks-that-are-juuuust-right">Peaks That Are Juuuust Right</p>
<div class="center figure"><p><img alt="Figure 16.13 - Tweaked peaks" src="chapters/pedometer-images/acceleration-filtered.png" /></p>
</div><p>Figure 16.13 - Tweaked peaks</p>
<p>In accounting for these four scenarios, we've managed to bring our messy
\(a(t)\) fairly close to our ideal sine wave (<a class="reference external" href="#figure-16.13">Figure 16.13</a>),
allowing us to count steps.</p>
<p class="rubric" id="recap">Recap</p>
<p>The problem, at first glance, looked straightforward. However, the real
world and real people threw a few curve balls our way. Let's recap how
we solved the problem:</p>
<ol class="arabic simple">
<li>We started with total acceleration, \((x(t), y(t), z(t))\).</li>
<li>We used a low-pass filter to split total acceleration into user
acceleration and gravitational acceleration, \((x_{u}(t),
y_{u}(t), z_{u}(t))\) and \((x_{g}(t), y_{g}(t), z_{g}(t))\),
respectively.</li>
<li>We took the dot product of \((x_{u}(t), y_{u}(t), z_{u}(t))\)
and \((x_{g}(t), y_{g}(t), z_{g}(t))\) to obtain the user
acceleration in the direction of gravity, \(a(t)\).</li>
<li>We used a low-pass filter again to remove the high-frequency
component of \(a(t)\), removing noise.</li>
<li>We used a high-pass filter to cancel the low-frequency component of
\(a(t)\), removing slow peaks.</li>
<li>We set a threshold to ignore short peaks.</li>
<li>We used hysteresis to avoid double-counting steps with bumpy peaks.</li>
</ol>
<p>As software developers in a training or academic setting, we may have
been presented with a perfect signal and asked to write code to count
the steps in that signal. While that may have been an interesting coding
challenge, it wouldn't have been something we could apply in a live
situation. We saw that in reality, with gravity and people thrown into
the mix, the problem was a little more complex. We used mathematical
tools to address the complexities, and were able to solve a real-world
problem. It's time to translate our solution into code.</p>
<p class="rubric" id="diving-into-code">Diving Into Code</p>
<p>Our goal for this chapter is to create a web application in Ruby that
accepts accelerometer data, parses, processes, and analyzes the data,
and returns the number of steps taken, the distance travelled, and the
elapsed time.</p>
<p class="rubric" id="preliminary-work">Preliminary Work</p>
<p>Our solution requires us to filter our time series several times. Rather
than peppering filtering code throughout our program, it makes sense to
create a class that takes care of the filtering, and if we ever need to
enhance or modify it, we'll only ever need to change that one class.
This strategy is called <em>separation of concerns</em>, a commonly used design
principle which promotes splitting a program into distinct pieces, where
every piece has one primary concern. It's a beautiful way to write
clean, maintainable code that's easily extensible. We'll revisit this
idea several times throughout the chapter.</p>
<p>Let's dive into the filtering code, contained in, logically, a
<code class="docutils literal"><span class="pre">Filter</span></code> class.</p>
<div class="code ruby highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Filter</span>

  <span class="n">COEFFICIENTS_LOW_0_HZ</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.979133761292768</span><span class="p">,</span> <span class="mf">0.979521463540373</span><span class="p">],</span>
    <span class="n">beta</span><span class="p">:</span>  <span class="p">[</span><span class="mf">0.000086384997973502</span><span class="p">,</span> <span class="mf">0.000172769995947004</span><span class="p">,</span> <span class="mf">0.000086384997973502</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="n">COEFFICIENTS_LOW_5_HZ</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.80898117793047</span><span class="p">,</span> <span class="mf">0.827224480562408</span><span class="p">],</span>
    <span class="n">beta</span><span class="p">:</span>  <span class="p">[</span><span class="mf">0.095465967120306</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.172688631608676</span><span class="p">,</span> <span class="mf">0.095465967120306</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="n">COEFFICIENTS_HIGH_1_HZ</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.905384612118461</span><span class="p">,</span> <span class="mf">0.910092542787947</span><span class="p">],</span>
    <span class="n">beta</span><span class="p">:</span>  <span class="p">[</span><span class="mf">0.953986986993339</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.907503180919730</span><span class="p">,</span> <span class="mf">0.953986986993339</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">low_0_hz</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">COEFFICIENTS_LOW_0_HZ</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">low_5_hz</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">COEFFICIENTS_LOW_5_HZ</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">high_1_hz</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">COEFFICIENTS_HIGH_1_HZ</span><span class="p">)</span>
  <span class="n">end</span>

<span class="n">private</span>

  <span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">)</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">(</span><span class="mf">2.</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="n">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
      <span class="n">filtered_data</span> <span class="o">&lt;&lt;</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">alpha</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
                      <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>            <span class="o">*</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">beta</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                       <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">beta</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                       <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>          <span class="o">*</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">beta</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
                       <span class="n">filtered_data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">alpha</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                       <span class="n">filtered_data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">alpha</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">end</span>
    <span class="n">filtered_data</span>
  <span class="n">end</span>

<span class="n">end</span>
</pre></div>
</div>
<p>Anytime our program needs to filter a time series, we can call one of
the class methods in <code class="docutils literal"><span class="pre">Filter</span></code> with the data we need filtered:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">low_0_hz</span></code> is used to low-pass filter signals near 0 Hz</li>
<li><code class="docutils literal"><span class="pre">low_5_hz</span></code> is used to low-pass filter signals at or below 5 Hz</li>
<li><code class="docutils literal"><span class="pre">high_1_hz</span></code> is used to high-pass filter signals above 1 Hz</li>
</ul>
<p>Each class method calls <code class="docutils literal"><span class="pre">filter</span></code>, which implements the IIR filter and
returns the result. If we wish to add more filters in the future, we
only need to change this one class. Note is that all magic numbers are
defined at the top. This makes our class easier to read and understand.</p>
<p class="rubric" id="input-formats">Input Formats</p>
<p>Our input data is coming from mobile devices such as Android phones and
iPhones. Most mobile phones on the market today have accelerometers
built in, that are able to record total acceleration. Let's call the
input data format that records total acceleration the <em>combined format</em>.
Many, but not all, devices can also record user acceleration and
gravitational acceleration separately. Let's call this format the
<em>separated format</em>. A device that has the ability to return data in the
separated format necessarily has the ability to return data in the
combined format. However, the inverse is not always true. Some devices
can only record data in the combined format. Input data in the combined
format will need to be passed through a low-pass filter to turn it into
the separated format.</p>
<p>We want our program to handle all mobile devices on the market with
accelerometers, so we'll need to accept data in both formats. Let's look
at the two formats we'll be accepting individually.</p>
<p class="rubric" id="combined-format">Combined Format</p>
<p>Data in the combined format is total acceleration in the \(x\),
\(y\), and \(z\) directions, over time. \(x\), \(y\), and
\(z\) values will be separated by a comma, and samples per unit time
will be separated by a semi-colon.</p>
<p>\[ x_1,y_1,z_1; \ldots x_n,y_n,z_n; \]</p>
<p class="rubric" id="separated-format">Separated Format</p>
<p>The separated format returns user acceleration and gravitational
acceleration in the \(x\), \(y\), and \(z\) directions, over time.
User acceleration values will be separated from gravitational
acceleration values by a pipe.</p>
<p>\[ x^{u}_1,y^{u}_1,z^{u}_1 \vert x^{g}_1,y^{g}_1,z^{g}_1;
\ldots x^{u}_n,y^{u}_n,z^{u}_n \vert x^{g}_n,y^{g}_n,z^{g}_n;
\]</p>
<p class="rubric" id="i-got-multiple-input-formats-but-a-standard-aint-one">I Got Multiple Input Formats But a Standard Ain't One</p>
<p>Dealing with multiple input formats is a common programming problem. If
we want our entire program to work with both formats, every single piece
of code dealing with the data would need to know how to handle both
formats. This can become very messy, very quickly, especially if a third
(or a fourth, or a fifth, or a hundredth) input format is added.</p>
<p class="rubric" id="standard-format">Standard Format</p>
<p>The cleanest way for us to deal with this is to take our two input
formats and fit them into a standard format as soon as possible,
allowing the rest of the program to work with this new standard format.
Our solution requires that we work with user acceleration and
gravitational acceleration separately, so our standard format will need
to be split into the two accelerations (<a class="reference external" href="#figure-16.14">Figure 16.14</a>).</p>
<div class="center figure"><p><img alt="Figure 16.14 - Standard format" src="chapters/pedometer-images/standard-format.png" /></p>
</div><p>Figure 16.14 - Standard format</p>
<p>Our standard format allows us to store a time series, as each element
represents acceleration at a point in time. We've defined it as an array
of arrays of arrays. Let's peel that onion.</p>
<ul class="simple">
<li>The first array is just a wrapper to hold the all of the data.</li>
<li>The second set of arrays contains one array per data sample taken. If
our sampling rate is 100 and we sample data for 10 seconds, we'll
have \(100 * 10\), or 1000, arrays in this second set.</li>
<li>The third set of arrays is the pair of arrays enclosed within the
second set. They both contain acceleration data in the \(x\),
\(y\), and \(z\) directions; the first representing user
acceleration and the second, gravitational acceleration.</li>
</ul>
<p class="rubric" id="the-pipeline">The Pipeline</p>
<p>The input into our system will be data from an accelerometer,
information on the user taking the walk (gender, stride, etc.), and
information on the trial walk itself (sampling rate, actual steps taken,
etc.). Our system will apply the signal processing solution, and output
the number of steps calculated, the delta between the actual steps and
calculated steps, the distance travelled, and the elapsed time. The
entire process from input to output can be viewed as a pipeline (<a class="reference external" href="#figure-16.15">Figure
16.15</a>).</p>
<div class="center figure"><p><img alt="Figure 16.15 - The pipeline" src="chapters/pedometer-images/pipeline.png" /></p>
</div><p>Figure 16.15 - The pipeline</p>
<p>In the spirit of separation of concerns, we'll write the code for each
distinct component of the pipeline—parsing, processing, and
analyzing—individually.</p>
<p class="rubric" id="parsing">Parsing</p>
<p>Given that we want our data in the standard format as early as possible,
it makes sense to write a parser that allows us to take our two known
input formats and convert them to a standard output format as the first
component of our pipeline. Our standard format splits out user
acceleration and gravitational acceleration, which means that if our
data is in the combined format, our parser will need to first pass it
through a low-pass filter to convert it to the standard format.</p>
<div class="center figure"><p><img alt="Figure 16.16 - Initial workflow" src="chapters/pedometer-images/input-data-workflow-1.png" /></p>
</div><p>Figure 16.16 - Initial workflow</p>
<p>In the future, if we ever have to add another input format, the only
code we'll have to touch is this parser. Let's separate concerns once
more, and create a <code class="docutils literal"><span class="pre">Parser</span></code> class to handle the parsing.</p>
<div class="code ruby highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parser</span>

  <span class="n">attr_reader</span> <span class="p">:</span><span class="n">parsed_data</span>

  <span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">parse</span>
    <span class="n">parser</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nd">@data</span> <span class="o">=</span> <span class="n">data</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">parse</span>
    <span class="nd">@parsed_data</span> <span class="o">=</span> <span class="nd">@data</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="p">}</span>
                   <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">:</span><span class="n">to_f</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>

    <span class="n">unless</span> <span class="nd">@parsed_data</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">:</span><span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span> <span class="p">}</span><span class="o">.</span><span class="n">uniq</span> <span class="o">==</span> <span class="p">[[</span><span class="mi">3</span><span class="p">]]</span>
      <span class="k">raise</span> <span class="s1">&#39;Bad Input. Ensure data is properly formatted.&#39;</span>
    <span class="n">end</span>

    <span class="k">if</span> <span class="nd">@parsed_data</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="n">filtered_accl</span> <span class="o">=</span> <span class="nd">@parsed_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">:</span><span class="n">flatten</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="o">.</span><span class="n">map</span> <span class="n">do</span> <span class="o">|</span><span class="n">total_accl</span><span class="o">|</span>
        <span class="n">grav</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">low_0_hz</span><span class="p">(</span><span class="n">total_accl</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">total_accl</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">grav</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="p">}</span>
        <span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">grav</span><span class="p">]</span>
      <span class="n">end</span>

      <span class="nd">@parsed_data</span> <span class="o">=</span> <span class="nd">@parsed_data</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span> <span class="n">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">filtered_accl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">:</span><span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">elem</span><span class="o">|</span> <span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">}</span>
        <span class="n">grav</span> <span class="o">=</span> <span class="n">filtered_accl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">:</span><span class="n">last</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">elem</span><span class="o">|</span> <span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">}</span>
        <span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">grav</span><span class="p">]</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

<span class="n">end</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">Parser</span></code> has a class-level <code class="docutils literal"><span class="pre">run</span></code> method as well as an initializer.
This is a pattern we'll use several times, so it's worth a discussion.
Initializers should generally be used for setting up an object, and
shouldn't do a lot of work. <code class="docutils literal"><span class="pre">Parser</span></code>'s initializer simply takes
<code class="docutils literal"><span class="pre">data</span></code> in the combined or separated format and stores it in the
instance variable <code class="docutils literal"><span class="pre">&#64;data</span></code>. The <code class="docutils literal"><span class="pre">parse</span></code> instance method uses
<code class="docutils literal"><span class="pre">&#64;data</span></code> internally, and does the heavy lifting of parsing and setting
the result in the standard format to <code class="docutils literal"><span class="pre">&#64;parsed_data</span></code>. In our case,
we'll never need to instantiate a <code class="docutils literal"><span class="pre">Parser</span></code> instance without having to
immediately call <code class="docutils literal"><span class="pre">parse</span></code>. Therefore, we add a convenient class-level
<code class="docutils literal"><span class="pre">run</span></code> method that instantiates an instance of <code class="docutils literal"><span class="pre">Parser</span></code>, calls
<code class="docutils literal"><span class="pre">parse</span></code> on it, and returns the instance of the object. We can now pass
our input data to <code class="docutils literal"><span class="pre">run</span></code>, knowing we'll receive an instance of
<code class="docutils literal"><span class="pre">Parser</span></code> with <code class="docutils literal"><span class="pre">&#64;parsed_data</span></code> already set.</p>
<p>Let's take a look at our hard-working <code class="docutils literal"><span class="pre">parse</span></code> method. The first step
in the process is to take string data and convert it to numerical data,
giving us an array of arrays of arrays. Sound familiar? The next thing
we do is ensure that the format is as expected. Unless we have exactly
three elements per the innermost arrays, we throw an exception.
Otherwise, we continue on.</p>
<p>Note the differences in <code class="docutils literal"><span class="pre">&#64;parsed_data</span></code> between the two formats at this
stage. In the <em>combined format</em> it contains arrays of exactly <em>one</em>
array:</p>
<p>\[ [[[x_1, y_1, z_1]], \ldots [[x_n, y_n, z_n]] \]</p>
<p>In the <em>separated format</em> it contains arrays of exactly <em>two</em> arrays:</p>
<p>\[[[[x_{u}^1,y_{u}^1,z_{u}^1], [x_{g}^1,y_{g}^1,z_{g}^1]], ...
[[x_{u}^n,y_{u}^n,z_{u}^n], [x_{g}^n,y_{g}^n,z_{g}^n]]]\]</p>
<p>The separated format is already in our desired standard format after
this operation. Amazing. However, if the data is combined (or,
equivalently, has exactly one array where the separated format would
have two), then we proceed with two loops. The first loop splits total
acceleration into gravitational and user, using <code class="docutils literal"><span class="pre">Filter</span></code> with a
<code class="docutils literal"><span class="pre">:low_0_hz</span></code> type, and the second loop reorganizes the data into the
standard format.</p>
<p><code class="docutils literal"><span class="pre">parse</span></code> leaves us with <code class="docutils literal"><span class="pre">&#64;parsed_data</span></code> holding data in the standard
format, regardless of whether we started off with combined or separated
data. What a relief!</p>
<p>As our program becomes more sophisticated, one area for improvement is
to make our users' lives easier by throwing exceptions with more
specific error messages, allowing them to more quickly track down common
input formatting problems.</p>
<p class="rubric" id="processing">Processing</p>
<p>Based on the solution we defined, we'll need our code to do a couple of
things to our parsed data before we can count steps:</p>
<ol class="arabic simple">
<li>Isolate movement in the direction of gravity using the dot product.</li>
<li>Remove jumpy (high-frequency) and slow (low-frequency) peaks with a
low-pass filter followed by a high-pass filter.</li>
</ol>
<p>We'll handle short and bumpy peaks by avoiding them during step
counting.</p>
<p>Now that we have our data in the standard format, we can process it to
get in into a state where we can analyze it to count steps (<a class="reference external" href="#figure-16.17">Figure
16.17</a>).</p>
<div class="center figure"><p><img alt="Figure 16.17 - Processing" src="chapters/pedometer-images/input-data-workflow-2.png" /></p>
</div><p>Figure 16.17 - Processing</p>
<p>The purpose of processing is to take our data in the standard format and
incrementally clean it up to get it to a state as close as possible to
our ideal sine wave. Our two processing operations, taking the dot
product and filtering, are quite distinct, but both are intended to
process our data, so we'll create one class called a <code class="docutils literal"><span class="pre">Processor</span></code>.</p>
<div class="code ruby highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Processor</span>

  <span class="n">attr_reader</span> <span class="p">:</span><span class="n">dot_product_data</span><span class="p">,</span> <span class="p">:</span><span class="n">filtered_data</span>

  <span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">Processor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">dot_product</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">filter</span>
    <span class="n">processor</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nd">@data</span> <span class="o">=</span> <span class="n">data</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">dot_product</span>
    <span class="nd">@dot_product_data</span> <span class="o">=</span> <span class="nd">@data</span><span class="o">.</span><span class="n">map</span> <span class="n">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
      <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">filter</span>
    <span class="nd">@filtered_data</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">low_5_hz</span><span class="p">(</span><span class="nd">@dot_product_data</span><span class="p">)</span>
    <span class="nd">@filtered_data</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">high_1_hz</span><span class="p">(</span><span class="nd">@filtered_data</span><span class="p">)</span>
  <span class="n">end</span>

<span class="n">end</span>
</pre></div>
</div>
<p>Again, we see the <code class="docutils literal"><span class="pre">run</span></code> and <code class="docutils literal"><span class="pre">initialize</span></code> methods pattern. <code class="docutils literal"><span class="pre">run</span></code>
calls our two processor methods, <code class="docutils literal"><span class="pre">dot_product</span></code> and <code class="docutils literal"><span class="pre">filter</span></code>,
directly. Each method accomplishes one of our two processing operations.
<code class="docutils literal"><span class="pre">dot_product</span></code> isolates movement in the direction of gravity, and
<code class="docutils literal"><span class="pre">filter</span></code> applies the low-pass and high-pass filters in sequence to
remove jumpy and slow peaks.</p>
<p class="rubric" id="pedometer-functionality">Pedometer Functionality</p>
<p>Provided information about the person using the pedometer is available,
we can measure more than just steps. Our pedometer will measure
<strong>distance travelled</strong> and <strong>elapsed time</strong>, as well as <strong>steps taken</strong>.</p>
<p class="rubric" id="distance-travelled">Distance Travelled</p>
<p>A mobile pedometer is generally used by one person. Distance travelled
during a walk is calculated by multiplying the steps taken by the
person's stride length. If the stride length is unknown, we can use
optional user information like gender and height to approximate it.
Let's create a <code class="docutils literal"><span class="pre">User</span></code> class to encapsulate this related information.</p>
<div class="code ruby highlight-default"><div class="highlight"><pre><span></span>class User

  GENDER      = [&#39;male&#39;, &#39;female&#39;]
  MULTIPLIERS = {&#39;female&#39; =&gt; 0.413, &#39;male&#39; =&gt; 0.415}
  AVERAGES    = {&#39;female&#39; =&gt; 70.0,  &#39;male&#39; =&gt; 78.0}

  attr_reader :gender, :height, :stride

  def initialize(gender = nil, height = nil, stride = nil)
    @gender = gender.to_s.downcase unless gender.to_s.empty?
    @height = Float(height) unless height.to_s.empty?
    @stride = Float(stride) unless stride.to_s.empty?

    raise &#39;Invalid gender&#39; if @gender &amp;&amp; !GENDER.include?(@gender)
    raise &#39;Invalid height&#39; if @height &amp;&amp; (@height &lt;= 0)
    raise &#39;Invalid stride&#39; if @stride &amp;&amp; (@stride &lt;= 0)

    @stride ||= calculate_stride
  end

private

  def calculate_stride
    if gender &amp;&amp; height
      MULTIPLIERS[@gender] * height
    elsif height
      height * (MULTIPLIERS.values.reduce(:+) / MULTIPLIERS.size)
    elsif gender
      AVERAGES[gender]
    else
      AVERAGES.values.reduce(:+) / AVERAGES.size
    end
  end

end
</pre></div>
</div>
<p>At the top of our class, we define constants to avoid hardcoding magic
numbers and strings throughout. For the purposes of this discussion,
let's assume that the values in <code class="docutils literal"><span class="pre">MULTIPLIERS</span></code> and <code class="docutils literal"><span class="pre">AVERAGES</span></code> have
been determined from a large sample size of diverse people.</p>
<p>Our initializer accepts <code class="docutils literal"><span class="pre">gender</span></code>, <code class="docutils literal"><span class="pre">height</span></code>, and <code class="docutils literal"><span class="pre">stride</span></code> as
optional arguments. If the optional parameters are passed in, our
initializer sets instance variables of the same names, after some data
formatting. We raise an exception for invalid values.</p>
<p>Even when all optional parameters are provided, the input stride takes
precedence. If it's not provided, the <code class="docutils literal"><span class="pre">calculate_stride</span></code> method
determines the most accurate stride length possible for the user. This
is done with an <code class="docutils literal"><span class="pre">if</span></code> statement:</p>
<ul class="simple">
<li>The most accurate way to calculate stride length is to use a person's
height and a multiplier based on gender, provided we have a valid
gender and height.</li>
<li>A person's height is a better predictor of stride than their gender
is. If we have height but not gender, we can multiply the height by
the average of the two values in <code class="docutils literal"><span class="pre">MULTIPLIERS</span></code>.</li>
<li>If all we have is a gender, we can use the average stride length from
<code class="docutils literal"><span class="pre">AVERAGES</span></code>.</li>
<li>Finally, if we don't have anything, we can take the average of the
two values in <code class="docutils literal"><span class="pre">AVERAGES</span></code> and use that as our stride.</li>
</ul>
<p>Note that the further down the <code class="docutils literal"><span class="pre">if</span></code> statement we get, the less
accurate our stride length becomes. In any case, our <code class="docutils literal"><span class="pre">User</span></code> class
determines the stride length as best it can.</p>
<p class="rubric" id="elapsed-time">Elapsed Time</p>
<p>The time spent travelling is measured by dividing the number of data
samples in our <code class="docutils literal"><span class="pre">Processor</span></code>'s <code class="docutils literal"><span class="pre">&#64;parsed_data</span></code> by the sampling rate of
the device, if we have it. Since the rate has more to do with the trial
walk itself than the user, and the <code class="docutils literal"><span class="pre">User</span></code> class in fact does not have
to be aware of the sampling rate, this is a good time to create a very
small <code class="docutils literal"><span class="pre">Trial</span></code> class.</p>
<div class="code ruby highlight-default"><div class="highlight"><pre><span></span>class Trial

  attr_reader :name, :rate, :steps

  def initialize(name, rate = nil, steps = nil)
    @name  = name.to_s.delete(&#39; &#39;)
    @rate  = Integer(rate.to_s) unless rate.to_s.empty?
    @steps = Integer(steps.to_s) unless steps.to_s.empty?

    raise &#39;Invalid name&#39;  if @name.empty?
    raise &#39;Invalid rate&#39;  if @rate &amp;&amp; (@rate &lt;= 0)
    raise &#39;Invalid steps&#39; if @steps &amp;&amp; (@steps &lt; 0)
  end

end
</pre></div>
</div>
<p>All of the attribute readers in <code class="docutils literal"><span class="pre">Trial</span></code> are set in the initializer
based on parameters passed in:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">name</span></code> is a name for the specific trial, to help differentiate
between the different trials.</li>
<li><code class="docutils literal"><span class="pre">rate</span></code> is the sampling rate of the accelerometer during the trial.</li>
<li><code class="docutils literal"><span class="pre">steps</span></code> is used to set the actual steps taken, so that we can
record the difference between the actual steps the user took and the
ones our program counted.</li>
</ul>
<p>Much like our <code class="docutils literal"><span class="pre">User</span></code> class, some information is optional. We're given
the opportunity to input details of the trial, if we have it. If we
don't have those details, our program bypasses calculating the
additional results, such as time spent travelling. Another similarity to
our <code class="docutils literal"><span class="pre">User</span></code> class is the prevention of invalid values.</p>
<p class="rubric" id="steps-taken">Steps Taken</p>
<p>It's time to implement our step counting strategy in code. So far, we
have a <code class="docutils literal"><span class="pre">Processor</span></code> class that contains <code class="docutils literal"><span class="pre">&#64;filtered_data</span></code>, which is
our clean time series representing user acceleration in the direction of
gravity. We also have classes that give us the necessary information
about the user and the trial. What we're missing is a way to analyze
<code class="docutils literal"><span class="pre">&#64;filtered_data</span></code> with the information from <code class="docutils literal"><span class="pre">User</span></code> and <code class="docutils literal"><span class="pre">Trial</span></code>, and
count steps, measure distance, and measure time.</p>
<p>The analysis portion of our program is different from the data
manipulation of the <code class="docutils literal"><span class="pre">Processor</span></code>, and different from the information
collection and aggregation of the <code class="docutils literal"><span class="pre">User</span></code> and <code class="docutils literal"><span class="pre">Trial</span></code> classes. Let's
create a new class called <code class="docutils literal"><span class="pre">Analyzer</span></code> to perform this data analysis.</p>
<div class="code ruby highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Analyzer</span>

  <span class="n">THRESHOLD</span> <span class="o">=</span> <span class="mf">0.09</span>

  <span class="n">attr_reader</span> <span class="p">:</span><span class="n">steps</span><span class="p">,</span> <span class="p">:</span><span class="n">delta</span><span class="p">,</span> <span class="p">:</span><span class="n">distance</span><span class="p">,</span> <span class="p">:</span><span class="n">time</span>

  <span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">Analyzer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">measure_steps</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">measure_delta</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">measure_distance</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">measure_time</span>
    <span class="n">analyzer</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
    <span class="nd">@data</span>  <span class="o">=</span> <span class="n">data</span>
    <span class="nd">@user</span>  <span class="o">=</span> <span class="n">user</span>
    <span class="nd">@trial</span> <span class="o">=</span> <span class="n">trial</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">measure_steps</span>
    <span class="nd">@steps</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_steps</span> <span class="o">=</span> <span class="n">true</span>

    <span class="nd">@data</span><span class="o">.</span><span class="n">each_with_index</span> <span class="n">do</span> <span class="o">|</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">THRESHOLD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nd">@data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">THRESHOLD</span><span class="p">)</span>
        <span class="nb">next</span> <span class="n">unless</span> <span class="n">count_steps</span>

        <span class="nd">@steps</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">count_steps</span> <span class="o">=</span> <span class="n">false</span>
      <span class="n">end</span>

      <span class="n">count_steps</span> <span class="o">=</span> <span class="n">true</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nd">@data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">measure_delta</span>
    <span class="nd">@delta</span> <span class="o">=</span> <span class="nd">@steps</span> <span class="o">-</span> <span class="nd">@trial</span><span class="o">.</span><span class="n">steps</span> <span class="k">if</span> <span class="nd">@trial</span><span class="o">.</span><span class="n">steps</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">measure_distance</span>
    <span class="nd">@distance</span> <span class="o">=</span> <span class="nd">@user</span><span class="o">.</span><span class="n">stride</span> <span class="o">*</span> <span class="nd">@steps</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">measure_time</span>
    <span class="nd">@time</span> <span class="o">=</span> <span class="nd">@data</span><span class="o">.</span><span class="n">count</span><span class="o">/</span><span class="nd">@trial</span><span class="o">.</span><span class="n">rate</span> <span class="k">if</span> <span class="nd">@trial</span><span class="o">.</span><span class="n">rate</span>
  <span class="n">end</span>

<span class="n">end</span>
</pre></div>
</div>
<p>The first thing we do in <code class="docutils literal"><span class="pre">Analyzer</span></code> is define a <code class="docutils literal"><span class="pre">THRESHOLD</span></code>
constant, which we'll use to avoid counting short peaks as steps. For
the purposes of this discussion, let's assume we've analyzed numerous
diverse data sets and determined a threshold value that accommodated the
largest number of those data sets. The threshold can eventually become
dynamic and vary with different users, based on the calculated versus
actual steps they've taken; a learning algorithm, if you will.</p>
<p>Our <code class="docutils literal"><span class="pre">Analyzer</span></code>'s initializer takes a <code class="docutils literal"><span class="pre">data</span></code> parameter and instances
of <code class="docutils literal"><span class="pre">User</span></code> and <code class="docutils literal"><span class="pre">Trial</span></code>, and sets the instance variables <code class="docutils literal"><span class="pre">&#64;data</span></code>,
<code class="docutils literal"><span class="pre">&#64;user</span></code>, and <code class="docutils literal"><span class="pre">&#64;trial</span></code> to the passed-in parameters. The <code class="docutils literal"><span class="pre">run</span></code>
method calls <code class="docutils literal"><span class="pre">measure_steps</span></code>, <code class="docutils literal"><span class="pre">measure_delta</span></code>, <code class="docutils literal"><span class="pre">measure_distance</span></code>,
and <code class="docutils literal"><span class="pre">measure_time</span></code>. Let's take a look at each method.</p>
<p class="rubric" id="measure-steps"><code class="docutils literal"><span class="pre">measure_steps</span></code></p>
<p>Finally! The step counting portion of our step counting app. The first
thing we do in <code class="docutils literal"><span class="pre">measure_steps</span></code> is initialize two variables:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;steps</span></code> is used to count the number of steps.</li>
<li><code class="docutils literal"><span class="pre">count_steps</span></code> is used for hysteresis to determine if we're allowed
to count steps at a point in time.</li>
</ul>
<p>We then iterate through <code class="docutils literal"><span class="pre">&#64;processor.filtered_data</span></code>. If the current
value is greater than or equal to <code class="docutils literal"><span class="pre">THRESHOLD</span></code>, and the previous value
was less than <code class="docutils literal"><span class="pre">THRESHOLD</span></code>, then we've crossed the threshold in the
positive direction, which could indicate a step. The <code class="docutils literal"><span class="pre">unless</span></code>
statement skips ahead to the next data point if <code class="docutils literal"><span class="pre">count_steps</span></code> is
<code class="docutils literal"><span class="pre">false</span></code>, indicating that we've already counted a step for that peak.
If we haven't, we increment <code class="docutils literal"><span class="pre">&#64;steps</span></code> by 1, and set <code class="docutils literal"><span class="pre">count_steps</span></code> to
<code class="docutils literal"><span class="pre">false</span></code> to prevent any more steps from being counted for that peak.
The next <code class="docutils literal"><span class="pre">if</span></code> statement sets <code class="docutils literal"><span class="pre">count_steps</span></code> to true once our time
series has crossed the \(x\)-axis in the negative direction, and we're
on to the next peak.</p>
<p>There we have it, the step counting portion of our program! Our
<code class="docutils literal"><span class="pre">Processor</span></code> class did a lot of work to clean up the time series and
remove frequencies that would result in counting false steps, so our
actual step counting implementation is not complex.</p>
<p>It's worth noting that we store the entire time series for the walk in
memory. Our trials are all short walks, so that's not currently a
problem, but eventually we'd like to analyze long walks with large
amounts of data. Ideally, we'd want to stream data in, only storing very
small portions of the time series in memory. Keeping this in mind, we've
put in the work to ensure that we only need the current data point and
the data point before it. Additionally, we've implemented hysteresis
using a Boolean value, so we don't need to look backward in the time
series to ensure we've crossed the \(x\)-axis at 0.</p>
<p>There's a fine balance between accounting for likely future iterations
of the product, and over-engineering a solution for every conceivable
product direction under the sun. In this case, it's reasonable to assume
that we'll have to handle longer walks in the near future, and the costs
of accounting for that in step counting are fairly low.</p>
<p class="rubric" id="measure-delta"><code class="docutils literal"><span class="pre">measure_delta</span></code></p>
<p>If the trial provides actual steps taken during the walk,
<code class="docutils literal"><span class="pre">measure_delta</span></code> will return the difference between the calculated and
actual steps.</p>
<p class="rubric" id="measure-distance"><code class="docutils literal"><span class="pre">measure_distance</span></code></p>
<p>The distance is measured by multiplying our user's stride by the number
of steps. Since the distance depends on the step count,
<code class="docutils literal"><span class="pre">measure_steps</span></code> must be called before <code class="docutils literal"><span class="pre">measure_distance</span></code>.</p>
<p class="rubric" id="measure-time"><code class="docutils literal"><span class="pre">measure_time</span></code></p>
<p>As long as we have a sampling rate, time is calculated by dividing the
total number of samples in <code class="docutils literal"><span class="pre">filtered_data</span></code> by the sampling rate. It
follows, then, that time is calculated in seconds.</p>
<p class="rubric" id="tying-it-all-together-with-the-pipeline">Tying It All Together With the Pipeline</p>
<p>Our <code class="docutils literal"><span class="pre">Parser</span></code>, <code class="docutils literal"><span class="pre">Processor</span></code>, and <code class="docutils literal"><span class="pre">Analyzer</span></code> classes, while useful
individually, are definitely better together. Our program will often use
them to run through the pipeline we introduced earlier. Since the
pipeline will need to be run frequently, we'll create a <code class="docutils literal"><span class="pre">Pipeline</span></code>
class to run it for us.</p>
<div class="code ruby highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Pipeline</span>

  <span class="n">attr_reader</span> <span class="p">:</span><span class="n">data</span><span class="p">,</span> <span class="p">:</span><span class="n">user</span><span class="p">,</span> <span class="p">:</span><span class="n">trial</span><span class="p">,</span> <span class="p">:</span><span class="n">parser</span><span class="p">,</span> <span class="p">:</span><span class="n">processor</span><span class="p">,</span> <span class="p">:</span><span class="n">analyzer</span>

  <span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">feed</span>
    <span class="n">pipeline</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
    <span class="nd">@data</span>  <span class="o">=</span> <span class="n">data</span>
    <span class="nd">@user</span>  <span class="o">=</span> <span class="n">user</span>
    <span class="nd">@trial</span> <span class="o">=</span> <span class="n">trial</span>
  <span class="n">end</span>

  <span class="k">def</span> <span class="nf">feed</span>
    <span class="nd">@parser</span>    <span class="o">=</span> <span class="n">Parser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="nd">@data</span><span class="p">)</span>
    <span class="nd">@processor</span> <span class="o">=</span> <span class="n">Processor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="nd">@parser</span><span class="o">.</span><span class="n">parsed_data</span><span class="p">)</span>
    <span class="nd">@analyzer</span>  <span class="o">=</span> <span class="n">Analyzer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="nd">@processor</span><span class="o">.</span><span class="n">filtered_data</span><span class="p">,</span> <span class="nd">@user</span><span class="p">,</span> <span class="nd">@trial</span><span class="p">)</span>
  <span class="n">end</span>

<span class="n">end</span>
</pre></div>
</div>
<p>We use our now-familiar <code class="docutils literal"><span class="pre">run</span></code> pattern and supply <code class="docutils literal"><span class="pre">Pipeline</span></code> with
accelerometer data, and instances of <code class="docutils literal"><span class="pre">User</span></code> and <code class="docutils literal"><span class="pre">Trial</span></code>. The
<code class="docutils literal"><span class="pre">feed</span></code> method implements the pipeline, which entails running
<code class="docutils literal"><span class="pre">Parser</span></code> with the accelerometer data, then using the parser's parsed
data to run <code class="docutils literal"><span class="pre">Processor</span></code>, and finally using the processor's filtered
data to run <code class="docutils literal"><span class="pre">Analyzer</span></code>. The <code class="docutils literal"><span class="pre">Pipeline</span></code> keeps <code class="docutils literal"><span class="pre">&#64;parser</span></code>,
<code class="docutils literal"><span class="pre">&#64;processor</span></code>, and <code class="docutils literal"><span class="pre">&#64;analyzer</span></code> instance variables, so that the
program has access to information from those objects for display
purposes through the app.</p>
<p class="rubric" id="adding-a-friendly-interface">Adding A Friendly Interface</p>
<p>We're through the most labour intensive part of our program. Next, we'll
build a web app to present the data in a format that is pleasing to a
user. A web app naturally separates the data processing from the
presentation of the data. Let's look at our app from a user's
perspective before the code.</p>
<p class="rubric" id="a-user-scenario">A User Scenario</p>
<p>When a user first enters the app by navigating to <code class="docutils literal"><span class="pre">/uploads</span></code>, they see
a table of existing data and a form to submit new data by uploading an
accelerometer output file and trial and user information (<a class="reference external" href="#figure-16.18">Figure
16.18</a>).</p>
<div class="center figure"><p><img alt="Figure 16.18 - Upload view" src="chapters/pedometer-images/app1.png" /></p>
</div><p>Figure 16.18 - Upload view</p>
<p>Submitting the form stores the data to the file system, parses,
processes, and analyzes it, and redirects back to <code class="docutils literal"><span class="pre">/uploads</span></code> with the
new entry in the table.</p>
<p>Clicking the <strong>Detail</strong> link for an entry presents the user with the
following view in <a class="reference external" href="#figure-16.19">Figure 16.19</a>.</p>
<div class="center figure"><p><img alt="Figure 16.19 - Detail view" src="chapters/pedometer-images/app3.png" /></p>
</div><p>Figure 16.19 - Detail view</p>
<p>The information presented includes values input by the user through the
upload form, values calculated by our program, and graphs of the time
series following the dot product operation, and again following
filtering. The user can navigate back to <code class="docutils literal"><span class="pre">/uploads</span></code> using the <em>Back to
Uploads</em> link.</p>
<p>Let's look at what the outlined functionality above implies for us,
technically. We'll need two major components that we don't yet have:</p>
<ol class="arabic simple">
<li>A way to store and retrieve user input data.</li>
<li>A web application with a basic interface.</li>
</ol>
<p>Let's examine each of these two requirements.</p>
<p class="rubric" id="storing-and-retrieving-data">1. Storing and Retrieving Data</p>
<p>Our app needs to store input data to, and retrieve data from, the file
system. We'll create an <code class="docutils literal"><span class="pre">Upload</span></code> class to do this. Since the class
deals only with the file system and doesn't relate directly to the
implementation of the pedometer, we've left it out for brevity, but it's
worth discussing its basic functionality. Our <code class="docutils literal"><span class="pre">Upload</span></code> class has three
class-level methods for file system access and retrieval, all of which
return one or more instances of <code class="docutils literal"><span class="pre">Upload</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">create</span></code> takes a file along with user and trial information. It
stores the file to the file system, under a filename it generates to
contain the user and trial information. The <code class="docutils literal"><span class="pre">&#64;file_path</span></code>,
<code class="docutils literal"><span class="pre">&#64;user</span></code>, and <code class="docutils literal"><span class="pre">&#64;trial</span></code> instance variables allow access to the file
path, user object, and trial object, respectively.</li>
<li><code class="docutils literal"><span class="pre">find</span></code> takes a file path and returns an instance of <code class="docutils literal"><span class="pre">Upload</span></code>.</li>
<li><code class="docutils literal"><span class="pre">all</span></code> returns an array of <code class="docutils literal"><span class="pre">Upload</span></code> instances, one for each
accelerometer data file in the file system.</li>
</ul>
<p class="rubric" id="separation-of-concerns-in-upload">Separation of Concerns in Upload</p>
<p>Once again, we've been wise to separate concerns in our program. All
code related to storage and retrieval is contained in the <code class="docutils literal"><span class="pre">Upload</span></code>
class. As our application grows, we'll likely want to use a database
rather than saving everything to the file system. When the time comes
for that, all we have to do it change the <code class="docutils literal"><span class="pre">Upload</span></code> class. This makes
our refactoring simple and clean.</p>
<p>In the future, we can save <code class="docutils literal"><span class="pre">User</span></code> and <code class="docutils literal"><span class="pre">Trial</span></code> objects to the
database. The <code class="docutils literal"><span class="pre">create</span></code>, <code class="docutils literal"><span class="pre">find</span></code>, and <code class="docutils literal"><span class="pre">all</span></code> methods in <code class="docutils literal"><span class="pre">Upload</span></code>
will then be relevant to <code class="docutils literal"><span class="pre">User</span></code> and <code class="docutils literal"><span class="pre">Trial</span></code> as well. That means we'd
likely refactor those out into their own class to deal with data storage
and retrieval in general, and each of our <code class="docutils literal"><span class="pre">User</span></code>, <code class="docutils literal"><span class="pre">Trial</span></code>, and
<code class="docutils literal"><span class="pre">Upload</span></code> classes would inherit from that class. We might eventually
add helper query methods to that class, and continue building it up from
there.</p>
<p class="rubric" id="building-a-web-application">2. Building a Web Application</p>
<p>Web apps have been built many times over, so we'll leverage the
important work of the open source community and use an existing
framework to do the boring plumbing work for us. The Sinatra framework
does just that. In the tool's own words, Sinatra is &quot;a DSL for quickly
creating web applications in Ruby&quot;. Perfect.</p>
<p>Our web app will need to respond to HTTP requests, so we'll need a file
that defines a route and associated code block for each combination of
HTTP method and URL. Let's call it <code class="docutils literal"><span class="pre">pedometer.rb</span></code>.</p>
<div class="code ruby highlight-default"><div class="highlight"><pre><span></span><span class="n">get</span> <span class="s1">&#39;/uploads&#39;</span> <span class="n">do</span>
  <span class="nd">@error</span> <span class="o">=</span> <span class="s2">&quot;A #</span><span class="si">{params[:error]}</span><span class="s2"> error has occurred.&quot;</span> <span class="k">if</span> <span class="n">params</span><span class="p">[:</span><span class="n">error</span><span class="p">]</span>
  <span class="nd">@pipelines</span> <span class="o">=</span> <span class="n">Upload</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">inject</span><span class="p">([])</span> <span class="n">do</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">upload</span><span class="o">|</span>
    <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">upload</span><span class="o">.</span><span class="n">file_path</span><span class="p">),</span> <span class="n">upload</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">upload</span><span class="o">.</span><span class="n">trial</span><span class="p">)</span>
    <span class="n">a</span>
  <span class="n">end</span>

  <span class="n">erb</span> <span class="p">:</span><span class="n">uploads</span>
<span class="n">end</span>

<span class="n">get</span> <span class="s1">&#39;/upload/*&#39;</span> <span class="n">do</span> <span class="o">|</span><span class="n">file_path</span><span class="o">|</span>
  <span class="n">upload</span> <span class="o">=</span> <span class="n">Upload</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
  <span class="nd">@pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span> <span class="n">upload</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">upload</span><span class="o">.</span><span class="n">trial</span><span class="p">)</span>

  <span class="n">erb</span> <span class="p">:</span><span class="n">upload</span>
<span class="n">end</span>

<span class="n">post</span> <span class="s1">&#39;/create&#39;</span> <span class="n">do</span>
  <span class="n">begin</span>
    <span class="n">Upload</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="n">data</span><span class="p">][:</span><span class="n">tempfile</span><span class="p">],</span> <span class="n">params</span><span class="p">[:</span><span class="n">user</span><span class="p">],</span> <span class="n">params</span><span class="p">[:</span><span class="n">trial</span><span class="p">])</span>

    <span class="n">redirect</span> <span class="s1">&#39;/uploads&#39;</span>
  <span class="n">rescue</span> <span class="ne">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="n">redirect</span> <span class="s1">&#39;/uploads?error=creation&#39;</span>
  <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">pedometer.rb</span></code> allows our app to respond to HTTP requests for each of
our routes. Each route's code block either retrieves data from, or
stores data to, the file system through <code class="docutils literal"><span class="pre">Upload</span></code>, and then renders a
view or redirects. The instance variables instantiated will be used
directly in our views. The views simply display the data and aren't the
focus of our app, so we we'll leave the code for them out of this
chapter.</p>
<p>Let's look at each of the routes in <code class="docutils literal"><span class="pre">pedometer.rb</span></code> individually.</p>
<p class="rubric" id="get-uploads"><code class="docutils literal"><span class="pre">GET</span> <span class="pre">/uploads</span></code></p>
<p>Navigating to <code class="docutils literal"><span class="pre">http://localhost:4567/uploads</span></code> sends an HTTP GET
request to our app, triggering our <code class="docutils literal"><span class="pre">get</span> <span class="pre">'/uploads'</span></code> code. The code
runs the pipeline for all of the uploads in the file system and renders
the <code class="docutils literal"><span class="pre">uploads</span></code> view, which displays a list of the uploads, and a form
to submit new uploads. If an error parameter is included, an error
string is created, and the <code class="docutils literal"><span class="pre">uploads</span></code> view will display the error.</p>
<p class="rubric" id="get-upload"><code class="docutils literal"><span class="pre">GET</span> <span class="pre">/upload/*</span></code></p>
<p>Clicking the <strong>Detail</strong> link for each upload sends an HTTP GET to
<code class="docutils literal"><span class="pre">/upload</span></code> with the file path for that upload. The pipeline runs, and
the <code class="docutils literal"><span class="pre">upload</span></code> view is rendered. The view displays the details of the
upload, including the charts, which are created using a JavaScript
library called HighCharts.</p>
<p class="rubric" id="post-create"><code class="docutils literal"><span class="pre">POST</span> <span class="pre">/create</span></code></p>
<p>Our final route, an HTTP POST to <code class="docutils literal"><span class="pre">create</span></code>, is called when a user
submits the form in the <code class="docutils literal"><span class="pre">uploads</span></code> view. The code block creates a new
<code class="docutils literal"><span class="pre">Upload</span></code>, using the <code class="docutils literal"><span class="pre">params</span></code> hash to grab the values input by the
user through the form, and redirects back to <code class="docutils literal"><span class="pre">/uploads</span></code>. If an error
occurs in the creation process, the redirect to <code class="docutils literal"><span class="pre">/uploads</span></code> includes an
error parameter to let the user know that something went wrong.</p>
<p class="rubric" id="a-fully-functional-app">A Fully Functional App</p>
<p>Voilà! We've built a fully functional app, with true applicability.</p>
<p>The real world presents us with intricate, complex challenges. Software
is uniquely capable of addressing these challenges at scale with minimal
resources. As software engineers, we have the power to create positive
change in our homes, our communities, and our world. Our training,
academic or otherwise, likely equipped us with the problem-solving
skills to write code that solves isolated, well-defined problems. As we
grow and hone our craft, it's up to us to extend that training to
address practical problems, tangled up with all of the messy realities
of our world. I hope that this chapter gave you a taste of breaking down
a real problem into small, addressable parts, and writing beautiful,
clean, extensible code to build a solution.</p>
<p>Here's to solving interesting problems in an endlessly exciting world.</p>
</div></div></div></div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Learn-Computer-and-Math-again</a></h1>








<h3>导航</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="blockcode-a-visual-programming-toolkit.html">500 Lines or Less | Blockcode: A visual programming toolkit</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, timger.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/chapters/a-pedometer-in-the-real-world.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>