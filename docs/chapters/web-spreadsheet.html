
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>500 Lines or Less | Web Spreadsheet &#8212; Learn-Computer-and-Math-again 0.0.1 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="lines-or-less-web-spreadsheet">
<h1>500 Lines or Less | Web Spreadsheet<a class="headerlink" href="#lines-or-less-web-spreadsheet" title="永久链接至标题">¶</a></h1>
<div class="container"><div class="row"><div class="hero-unit"><p><a href="#id1"><span class="problematic" id="id2">``</span></a>_
.. rubric:: Web Spreadsheet</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">name:</th><td class="field-body">web-spreadsheet</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="author rubric" id="audrey-tang">Audrey Tang</p>
</div></div><div class="row"><div id="content" class="span10 offset1"><p><em>A self-educated programmer and translator, Audrey works with Apple as
an independent contractor on cloud service localization and natural
language technologies. Audrey has previously designed and led the first
working Perl 6 implementation, and served in computer language design
committees for Haskell, Perl 5, and Perl 6. Currently Audrey is a
full-time g0v contributor and leads Taiwan’s first e-Rulemaking
project.</em></p>
<p>This chapter introduces a web spreadsheet written in 99 lines of the
three languages natively supported by web browsers: HTML, JavaScript,
and CSS.</p>
<p>The ES5 version of this project is available as a <a class="reference external" href="http://jsfiddle.net/audreyt/LtDyP/">jsFiddle</a>.</p>
<p><em>(This chapter is also available in `Traditional Chinese`_)</em>.</p>
<p class="rubric" id="introduction">Introduction</p>
<p>When Tim Berners-Lee invented the web in 1990, <em>web pages</em> were written
in HTML by marking up text with angle-bracketed <em>tags</em>, assigning a
logical structure to the content. Text marked up within <code class="docutils literal"><span class="pre">&lt;a&gt;…&lt;/a&gt;</span></code>
became <em>hyperlinks</em> that would refer the user to other pages on the web.</p>
<p>In the 1990s, browsers added various presentational tags to the HTML
vocabulary, including some notoriously nonstandard tags such as
<code class="docutils literal"><span class="pre">&lt;blink&gt;…&lt;/blink&gt;</span></code> from Netscape Navigator and
<code class="docutils literal"><span class="pre">&lt;marquee&gt;…&lt;/marquee&gt;</span></code> from Internet Explorer, causing widespread
problems in usability and browser compatibility.</p>
<p>In order to restrict HTML to its original purpose—describing a
document’s logical structure—browser makers eventually agreed to support
two additional languages: CSS to describe presentational styles of a
page, and JavaScript (JS) to describe its dynamic interactions.</p>
<p>Since then, the three languages have become more concise and powerful
through twenty years of co-evolution. In particular, improvements in JS
engines made it practical to deploy large-scale JS frameworks, such as
<a class="reference external" href="http://angularjs.org/">AngularJS</a>.</p>
<p>Today, cross-platform <em>web applications</em> (such as web spreadsheets) are
as ubiquitous and popular as platform-specific applications (such as
VisiCalc, Lotus 1-2-3 and Excel) from the previous century.</p>
<p>How many features can a web application offer in 99 lines with
AngularJS? Let’s see it in action!</p>
<p class="rubric" id="overview">Overview</p>
<p>The <a class="reference external" href="https://github.com/audreyt/500lines/tree/master/spreadsheet/code">spreadsheet</a> directory contains our showcase for late-2014
editions of the three web languages: <a class="reference external" href="http://www.w3.org/TR/html5/">HTML5</a> for structure, <a class="reference external" href="http://www.w3.org/TR/css3-ui/">CSS3</a> for
presentation, and the JS <a class="reference external" href="http://git.io/es6features">ES6 “Harmony”</a> standard for interaction. It
also uses <a class="reference external" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webstorage.html">web storage</a> for data persistence and <a class="reference external" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/workers.html">web workers</a> for
running JS code in the background. As of this writing, these web
standards are supported by Firefox, Chrome, and Internet Explorer 11+,
as well as mobile browsers on iOS 5+ and Android 4+.</p>
<p>Now let’s open <a class="reference external" href="http://audreyt.github.io/500lines/spreadsheet/">our spreadsheet</a> in a browser (<a class="reference external" href="#figure-19.1">Figure 19.1</a>):</p>
<div class="center figure"><p><img alt="Figure 19.1 - Initial Screen" src="chapters/spreadsheet-images/01-initial.png" /></p>
</div><p>Figure 19.1 - Initial Screen</p>
<p class="rubric" id="basic-concepts">Basic Concepts</p>
<p>The spreadsheet spans two dimensions, with <em>columns</em> starting from
<strong>A</strong>, and <em>rows</em> starting from <strong>1</strong>. Each <em>cell</em> has a unique
<em>coordinate</em> (such as <strong>A1</strong>) and <em>content</em> (such as &quot;1874&quot;), which
belongs to one of four <em>types</em>:</p>
<ul class="simple">
<li>Text: &quot;+&quot; in <strong>B1</strong> and &quot;-&gt;&quot; in <strong>D1</strong>, aligned to the left.</li>
<li>Number: &quot;1874&quot; in <strong>A1</strong> and &quot;2046&quot; in <strong>C1</strong>, aligned to the right.</li>
<li>Formula: <code class="docutils literal"><span class="pre">=A1+C1</span></code> in <strong>E1</strong>, which <em>calculates</em> to the <em>value</em>
&quot;3920&quot;, displayed with a light blue background.</li>
<li>Empty: All cells in row <strong>2</strong> are currently empty.</li>
</ul>
<p>Click &quot;3920&quot; to set <em>focus</em> on <strong>E1</strong>, revealing its formula in an
<em>input box</em> (<a class="reference external" href="#figure-19.2">Figure 19.2</a>).</p>
<div class="center figure"><p><img alt="Figure 19.2 - Input Box" src="chapters/spreadsheet-images/02-input.png" /></p>
</div><p>Figure 19.2 - Input Box</p>
<p>Now let’s set focus on <strong>A1</strong> and <em>change</em> its content to &quot;1&quot;, causing
<strong>E1</strong> to <em>recalculate</em> its value to &quot;2047&quot; (<a class="reference external" href="#figure-19.3">Figure 19.3</a>).</p>
<div class="center figure"><p><img alt="Figure 19.3 - Changed Content" src="chapters/spreadsheet-images/03-changed.png" /></p>
</div><p>Figure 19.3 - Changed Content</p>
<p>Press <strong>ENTER</strong> to set focus to <strong>A2</strong> and change its content to
<code class="docutils literal"><span class="pre">=Date()</span></code>, then press <strong>TAB</strong>, change the content of <strong>B2</strong> to
<code class="docutils literal"><span class="pre">=alert()</span></code>, then press <strong>TAB</strong> again to set focus to <code class="docutils literal"><span class="pre">C2</span></code> (<a class="reference external" href="#figure-19.4">Figure
19.4</a>).</p>
<div class="center figure"><p><img alt="Figure 19.4 - Formula Error" src="chapters/spreadsheet-images/04-error.png" /></p>
</div><p>Figure 19.4 - Formula Error</p>
<p>This shows that a formula may calculate to a number (&quot;2047&quot; in <strong>E1</strong>),
a text (the current time in <strong>A2</strong>, aligned to the left), or an <em>error</em>
(red letters in <strong>B2</strong>, aligned to the center).</p>
<p>Next, let’s try entering <code class="docutils literal"><span class="pre">=for(;;){}</span></code>, the JS code for an infinite
loop that never terminates. The spreadsheet will prevent this by
automatically <em>restoring</em> the content of <strong>C2</strong> after an attempted
change.</p>
<p>Now reload the page in the browser with <strong>Ctrl-R</strong> or <strong>Cmd-R</strong> to
verify that the spreadsheet content is <em>persistent</em>, staying the same
across browser sessions. To <em>reset</em> the spreadsheet to its original
contents, press the 'curved arrow' button on the top-left corner.</p>
<p class="rubric" id="progressive-enhancement">Progressive Enhancement</p>
<p>Before we dive into the 99 lines of code, it’s worthwhile to disable JS
in the browser, reload the page, and note the differences (<a class="reference external" href="#figure-19.5">Figure
19.5</a>).</p>
<ul class="simple">
<li>Instead of a large grid, only a 2x2 table remains onscreen, with a
single content cell.</li>
<li>Row and column labels are replaced by <code class="docutils literal"><span class="pre">{{</span> <span class="pre">row</span> <span class="pre">}}</span></code> and
<code class="docutils literal"><span class="pre">{{</span> <span class="pre">col</span> <span class="pre">}}</span></code>.</li>
<li>Pressing the reset button produces no effect.</li>
<li>Pressing <strong>TAB</strong> or clicking into the first line of content still
reveals an editable input box.</li>
</ul>
<div class="center figure"><p><img alt="Figure 19.5 - With JavaScript Disabled" src="chapters/spreadsheet-images/05-nojs.png" /></p>
</div><p>Figure 19.5 - With JavaScript Disabled</p>
<p>When we disable the dynamic interactions (JS), the content structure
(HTML) and the presentational styles (CSS) remain in effect. If a
website is useful with both JS and CSS disabled, we say it adheres to
the <em>progressive enhancement</em> principle, making its content accessible
to the largest audience possible.</p>
<p>Because our spreadsheet is a web application with no server-side code,
we must rely on JS to provide the required logic. However, it does work
correctly when CSS is not fully supported, such as with screen readers
and text-mode browsers.</p>
<div class="center figure"><p><img alt="Figure 19.6 - With CSS Disabled" src="chapters/spreadsheet-images/06-nocss.png" /></p>
</div><p>Figure 19.6 - With CSS Disabled</p>
<p>As shown in <a class="reference external" href="#figure-19.6">Figure 19.6</a>, if we enable JS in the browser and disable
CSS instead, the effects are:</p>
<ul class="simple">
<li>All background and foreground colors are gone.</li>
<li>The input box and the cell value are both displayed, instead of just
one at a time.</li>
<li>Otherwise, the application still works the same as the full version.</li>
</ul>
<p class="rubric" id="code-walkthrough">Code Walkthrough</p>
<p><a class="reference external" href="#figure-19.7">Figure 19.7</a> shows the links between HTML and JS components. In order
to make sense of the diagram, let’s go through the four source code
files, in the same sequence as the browser loads them.</p>
<div class="center figure"><p><img alt="Figure 19.7 - Architecture Diagram" src="chapters/spreadsheet-images/00-architecture.png" /></p>
</div><p>Figure 19.7 - Architecture Diagram</p>
<ul class="simple">
<li><strong>index.html</strong>: 19 lines</li>
<li><strong>main.js</strong>: 38 lines (excluding comments and blank lines)</li>
<li><strong>worker.js</strong>: 30 lines (excluding comments and blank lines)</li>
<li><strong>styles.css</strong>: 12 lines</li>
</ul>
<p class="rubric" id="html">HTML</p>
<p>The first line in <code class="docutils literal"><span class="pre">index.html</span></code> declares that it’s written in HTML5
with the UTF-8 encoding:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;UTF-8&quot;&gt;
</pre></div>
</div>
<p>Without the <code class="docutils literal"><span class="pre">charset</span></code> declaration, the browser may display the reset
button’s Unicode symbol as <code class="docutils literal"><span class="pre">â†»</span></code>, an example of <em>mojibake</em>: garbled
text caused by decoding issues.</p>
<p>The next three lines are JS declarations, placed within the <code class="docutils literal"><span class="pre">head</span></code>
section as usual:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;lib/angular.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;main.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="k">try</span> <span class="p">{</span> <span class="n">angular</span><span class="o">.</span><span class="n">module</span><span class="p">(</span><span class="s1">&#39;500lines&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">catch</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;es5/index.html&quot;</span> <span class="p">}</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">&lt;script</span> <span class="pre">src=&quot;…&quot;&gt;</span></code> tags load JS resources from the same path as
the HTML page. For example, if the current URL is
<code class="docutils literal"><span class="pre">http://abc.com/x/index.html</span></code>, then <code class="docutils literal"><span class="pre">lib/angular.js</span></code> refers to
<code class="docutils literal"><span class="pre">http://abc.com/x/lib/angular.js</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">try{</span> <span class="pre">angular.module('500lines')</span> <span class="pre">}</span></code> line tests if <code class="docutils literal"><span class="pre">main.js</span></code> is
loaded correctly; if not, it tells the browser to navigate to
<code class="docutils literal"><span class="pre">es5/index.html</span></code> instead. This <em>redirect-based graceful degradation</em>
technique ensures that for pre-2015 browsers with no ES6 support, we can
use the translated-to-ES5 versions of JS programs as a fallback.</p>
<p>The next two lines load the CSS resource, close the <code class="docutils literal"><span class="pre">head</span></code> section,
and begin the <code class="docutils literal"><span class="pre">body</span></code> section containing the user-visible part:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span>  <span class="o">&lt;</span><span class="n">link</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;styles.css&quot;</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">body</span> <span class="n">ng</span><span class="o">-</span><span class="n">app</span><span class="o">=</span><span class="s2">&quot;500lines&quot;</span> <span class="n">ng</span><span class="o">-</span><span class="n">controller</span><span class="o">=</span><span class="s2">&quot;Spreadsheet&quot;</span> <span class="n">ng</span><span class="o">-</span><span class="n">cloak</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">ng-app</span></code> and <code class="docutils literal"><span class="pre">ng-controller</span></code> attributes above tell <a class="reference external" href="http://angularjs.org/">AngularJS</a>
to call the <code class="docutils literal"><span class="pre">500lines</span></code> module’s <code class="docutils literal"><span class="pre">Spreadsheet</span></code> function, which would
return a <em>model</em>: an object that provides <em>bindings</em> on the document
<em>view</em>. (The <code class="docutils literal"><span class="pre">ng-cloak</span></code> attribute hides the document from display
until the bindings are in place.)</p>
<p>As a concrete example, when the user clicks the <code class="docutils literal"><span class="pre">&lt;button&gt;</span></code> defined in
the next line, its <code class="docutils literal"><span class="pre">ng-click</span></code> attribute will trigger and call
<code class="docutils literal"><span class="pre">reset()</span></code> and <code class="docutils literal"><span class="pre">calc()</span></code>, two named functions provided by the JS
model:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span>&lt;table&gt;&lt;tr&gt;
  &lt;th&gt;&lt;button type=&quot;button&quot; ng-click=&quot;reset(); calc()&quot;&gt;↻&lt;/button&gt;&lt;/th&gt;
</pre></div>
</div>
<p>The next line uses <code class="docutils literal"><span class="pre">ng-repeat</span></code> to display the list of column labels on
the top row:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">th</span> <span class="n">ng</span><span class="o">-</span><span class="n">repeat</span><span class="o">=</span><span class="s2">&quot;col in Cols&quot;</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">col</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">th</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For example, if the JS model defines <code class="docutils literal"><span class="pre">Cols</span></code> as <code class="docutils literal"><span class="pre">[&quot;A&quot;,&quot;B&quot;,&quot;C&quot;]</span></code>, then
there will be three heading cells (<code class="docutils literal"><span class="pre">th</span></code>) labeled accordingly. The
<code class="docutils literal"><span class="pre">{{</span> <span class="pre">col</span> <span class="pre">}}</span></code> notation tells AngularJS to <em>interpolate</em> the expression,
filling the contents in each <code class="docutils literal"><span class="pre">th</span></code> with the current value of <code class="docutils literal"><span class="pre">col</span></code>.</p>
<p>Similarly, the next two lines go through values in <code class="docutils literal"><span class="pre">Rows</span></code> —
<code class="docutils literal"><span class="pre">[1,2,3]</span></code> and so on — creating a row for each one and labeling the
leftmost <code class="docutils literal"><span class="pre">th</span></code> cell with its number:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;</span><span class="n">tr</span> <span class="n">ng</span><span class="o">-</span><span class="n">repeat</span><span class="o">=</span><span class="s2">&quot;row in Rows&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">th</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">row</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">th</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Because the <code class="docutils literal"><span class="pre">&lt;tr</span> <span class="pre">ng-repeat&gt;</span></code> tag is not yet closed by <code class="docutils literal"><span class="pre">&lt;/tr&gt;</span></code> , the
<code class="docutils literal"><span class="pre">row</span></code> variable is still available for expressions. The next line
creates a data cell (<code class="docutils literal"><span class="pre">td</span></code>) in the current row and uses both <code class="docutils literal"><span class="pre">col</span></code>
and <code class="docutils literal"><span class="pre">row</span></code> variables in its <code class="docutils literal"><span class="pre">ng-class</span></code> attribute:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">td</span> <span class="n">ng</span><span class="o">-</span><span class="n">repeat</span><span class="o">=</span><span class="s2">&quot;col in Cols&quot;</span> <span class="n">ng</span><span class="o">-</span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;{ formula: (&#39;=&#39; === sheet[col+row][0]) }&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>A few things are going on here. In HTML, the <code class="docutils literal"><span class="pre">class</span></code> attribute
describes a <em>set of class names</em> that allow CSS to style them
differently. The <code class="docutils literal"><span class="pre">ng-class</span></code> here evaluates the expression
<code class="docutils literal"><span class="pre">('='</span> <span class="pre">===</span> <span class="pre">sheet[col+row][0])</span></code>; if it is true, then the <code class="docutils literal"><span class="pre">&lt;td&gt;</span></code> gets
<code class="docutils literal"><span class="pre">formula</span></code> as an additional class, which gives the cell a light-blue
background as defined in line 8 of <strong>styles.css</strong> with the <code class="docutils literal"><span class="pre">.formula</span></code>
<em>class selector</em>.</p>
<p>The expression above checks if the current cell is a formula by testing
if <code class="docutils literal"><span class="pre">=</span></code> is the initial character (<code class="docutils literal"><span class="pre">[0]</span></code>) of the string in
<code class="docutils literal"><span class="pre">sheet[col+row]</span></code>, where <code class="docutils literal"><span class="pre">sheet</span></code> is a JS model object with
coordinates (such as <code class="docutils literal"><span class="pre">&quot;E1&quot;</span></code>) as properties, and cell contents (such as
<code class="docutils literal"><span class="pre">&quot;=A1+C1&quot;</span></code>) as values. Note that because <code class="docutils literal"><span class="pre">col</span></code> is a string and not a
number, the <code class="docutils literal"><span class="pre">+</span></code> in <code class="docutils literal"><span class="pre">col+row</span></code> means concatenation instead of
addition.</p>
<p>Inside the <code class="docutils literal"><span class="pre">&lt;td&gt;</span></code>, we give the user an input box to edit the cell
content stored in <code class="docutils literal"><span class="pre">sheet[col+row]</span></code>:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nb">input</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;{{ col+row }}&quot;</span> <span class="n">ng</span><span class="o">-</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;sheet[col+row]&quot;</span> <span class="n">ng</span><span class="o">-</span><span class="n">change</span><span class="o">=</span><span class="s2">&quot;calc()&quot;</span>
 <span class="n">ng</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">options</span><span class="o">=</span><span class="s2">&quot;{ debounce: 200 }&quot;</span> <span class="n">ng</span><span class="o">-</span><span class="n">keydown</span><span class="o">=</span><span class="s2">&quot;keydown( $event, col, row )&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Here, the key attribute is <code class="docutils literal"><span class="pre">ng-model</span></code>, which enables a <em>two-way
binding</em> between the JS model and the input box’s editable content. In
practice, this means that whenever the user makes a change in the input
box, the JS model will update <code class="docutils literal"><span class="pre">sheet[col+row]</span></code> to match the content,
and trigger its <code class="docutils literal"><span class="pre">calc()</span></code> function to recalculate values of all formula
cells.</p>
<p>To avoid repeated calls to <code class="docutils literal"><span class="pre">calc()</span></code> when the user presses and holds a
key, <code class="docutils literal"><span class="pre">ng-model-options</span></code> limits the update rate to once every 200
milliseconds.</p>
<p>The <code class="docutils literal"><span class="pre">id</span></code> attribute here is interpolated with the coordinate
<code class="docutils literal"><span class="pre">col+row</span></code>. The <code class="docutils literal"><span class="pre">id</span></code> attribute of a HTML element must be different
from the <code class="docutils literal"><span class="pre">id</span></code> of all other elements in the same document. This ensures
that the <code class="docutils literal"><span class="pre">#A1</span></code> <em>ID selector</em> refers to a single element, instead of a
set of elements like the class selector <code class="docutils literal"><span class="pre">.formula</span></code>. When the user
presses the <strong>UP</strong>/<strong>DOWN</strong>/<strong>ENTER</strong> keys, the keyboard-navigation
logic in <code class="docutils literal"><span class="pre">keydown()</span></code> will use ID selectors to determine which input
box to focus on.</p>
<p>After the input box, we place a <code class="docutils literal"><span class="pre">&lt;div&gt;</span></code> to display the calculated
value of the current cell, represented in the JS model by objects
<code class="docutils literal"><span class="pre">errs</span></code> and <code class="docutils literal"><span class="pre">vals</span></code>:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">div</span> <span class="n">ng</span><span class="o">-</span><span class="n">class</span><span class="o">=</span><span class="s2">&quot;{ error: errs[col+row], text: vals[col+row][0] }&quot;</span><span class="o">&gt;</span>
  <span class="p">{{</span> <span class="n">errs</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="n">row</span><span class="p">]</span> <span class="o">||</span> <span class="n">vals</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="n">row</span><span class="p">]</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>If an error occurs when computing a formula, the text interpolation uses
the error message contained in <code class="docutils literal"><span class="pre">errs[col+row]</span></code>, and <code class="docutils literal"><span class="pre">ng-class</span></code>
applies the <code class="docutils literal"><span class="pre">error</span></code> class to the element, allowing CSS to style it
differently (with red letters, aligned to the center, etc.).</p>
<p>When there is no error, the <code class="docutils literal"><span class="pre">vals[col+row]</span></code> on the right side of
<code class="docutils literal"><span class="pre">||</span></code> is interpolated instead. If it’s a non-empty string, the initial
character (<code class="docutils literal"><span class="pre">[0]</span></code>) will evaluate to true, applying the <code class="docutils literal"><span class="pre">text</span></code> class
to the element that left-aligns the text.</p>
<p>Because empty strings and numeric values have no initial character,
<code class="docutils literal"><span class="pre">ng-class</span></code> will not assign them any classes, so CSS can style them
with right alignment as the default case.</p>
<p>Finally, we close the <code class="docutils literal"><span class="pre">ng-repeat</span></code> loop in the column level with
<code class="docutils literal"><span class="pre">&lt;/td&gt;</span></code>, close the row-level loop with <code class="docutils literal"><span class="pre">&lt;/tr&gt;</span></code>, and end the HTML
document with:</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span>    <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</pre></div>
</div>
<p class="rubric" id="js-main-controller">JS: Main Controller</p>
<p>The <code class="docutils literal"><span class="pre">main.js</span></code> file defines the <code class="docutils literal"><span class="pre">500lines</span></code> module and its
<code class="docutils literal"><span class="pre">Spreadsheet</span></code> controller function, as required by the <code class="docutils literal"><span class="pre">&lt;body&gt;</span></code>
element in <code class="docutils literal"><span class="pre">index.html</span></code>.</p>
<p>As the bridge between the HTML view and the background worker, it has
four tasks:</p>
<ul class="simple">
<li>Define the dimensions and labels of columns and rows.</li>
<li>Provide event handlers for keyboard navigation and the reset button.</li>
<li>When the user changes the spreadsheet, send its new content to the
worker.</li>
<li>When computed results arrive from the worker, update the view and
save the current state.</li>
</ul>
<p>The flowchart in <a class="reference external" href="#figure-19.8">Figure 19.8</a> shows the controller-worker interaction
in more detail:</p>
<div class="center figure"><p><img alt="Figure 19.8 - Controller-Worker Flowchart" src="chapters/spreadsheet-images/00-flowchart.png" /></p>
</div><p>Figure 19.8 - Controller-Worker Flowchart</p>
<p>Now let's walk through the code. In the first line, we request the
AngularJS <code class="docutils literal"><span class="pre">$scope</span></code>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>angular.module(&#39;500lines&#39;, []).controller(&#39;Spreadsheet&#39;, function ($scope, $timeout) {
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">$</span></code> in <code class="docutils literal"><span class="pre">$scope</span></code> is part of the variable name. Here we also
request the <a href="#id3"><span class="problematic" id="id4">``</span></a><a href="#id5"><span class="problematic" id="id6">`$timeout```_</span></a> service function from AngularJS; later on,
we will use it to prevent infinite-looping formulas.</p>
<p>To put <code class="docutils literal"><span class="pre">Cols</span></code> and <code class="docutils literal"><span class="pre">Rows</span></code> into the model, simply define them as
properties of <code class="docutils literal"><span class="pre">$scope</span></code>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// Begin of $scope properties; start with the column/row labels
$scope.Cols = [], $scope.Rows = [];
for (col of range( &#39;A&#39;, &#39;H&#39; )) { $scope.Cols.push(col); }
for (row of range( 1, 20 )) { $scope.Rows.push(row); }
</pre></div>
</div>
<p>The ES6 <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...of">for...of</a> syntax makes it easy to loop through ranges with a
start and an end point, with the helper function <code class="docutils literal"><span class="pre">range</span></code> defined as a
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*">generator</a>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">function</span><span class="o">*</span> <span class="nb">range</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span> <span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span> <span class="k">yield</span> <span class="n">cur</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">function*</span></code> above means that <code class="docutils literal"><span class="pre">range</span></code> returns an <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/The_Iterator_protocol">iterator</a>,
with a <code class="docutils literal"><span class="pre">while</span></code> loop that would <code class="docutils literal"><span class="pre">`yield```_</span> <span class="pre">a</span> <span class="pre">single</span> <span class="pre">value</span> <span class="pre">at</span> <span class="pre">a</span> <span class="pre">time.</span>
<span class="pre">Whenever</span> <span class="pre">the</span> <span class="pre">``for</span></code> loop demands the next value, it will resume
execution right after the <code class="docutils literal"><span class="pre">yield</span></code> line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>  // If it’s a number, increase it by one; otherwise move to next letter
  cur = (isNaN( cur ) ? String.fromCodePoint( cur.codePointAt()+1 ) : cur+1);
} }
</pre></div>
</div>
<p>To generate the next value, we use <code class="docutils literal"><span class="pre">isNaN</span></code> to see if <code class="docutils literal"><span class="pre">cur</span></code> is meant
as a letter (<code class="docutils literal"><span class="pre">NaN</span></code> stands for “not a number.”) If so, we get the
letter’s <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/codePointAt">code point value</a>, increment it by one, and <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCodePoint">convert the
codepoint</a> back to get its next letter. Otherwise, we simply increase
the number by one.</p>
<p>Next up, we define the <code class="docutils literal"><span class="pre">keydown()</span></code> function that handles keyboard
navigation across rows:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// UP(38) and DOWN(40)/ENTER(13) move focus to the row above (-1) and below (+1).
$scope.keydown = ({which}, col, row)=&gt;{ switch (which) {
</pre></div>
</div>
<p>The <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/arrow_functions">arrow function</a> receives the arguments <code class="docutils literal"><span class="pre">($event,</span> <span class="pre">col,</span> <span class="pre">row)</span></code> from
<code class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">ng-keydown&gt;</span></code>, using <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/New_in_JavaScript/1.7#Pulling_fields_from_objects_passed_as_function_parameter">destructuring assignment</a> to assign
<code class="docutils literal"><span class="pre">$event.which</span></code> into the <code class="docutils literal"><span class="pre">which</span></code> parameter, and checks if it’s among
the three navigational key codes:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>case 38: case 40: case 13: $timeout( ()=&gt;{
</pre></div>
</div>
<p>If it is, we use <code class="docutils literal"><span class="pre">$timeout</span></code> to schedule a focus change after the
current <code class="docutils literal"><span class="pre">ng-keydown</span></code> and <code class="docutils literal"><span class="pre">ng-change</span></code> handler. Because <code class="docutils literal"><span class="pre">$timeout</span></code>
requires a function as argument, the <code class="docutils literal"><span class="pre">()=&gt;{…}</span></code> syntax constructs a
function to represent the focus-change logic, which starts by checking
the direction of movement:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>const direction = (which === 38) ? -1 : +1;
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">const</span></code> declarator means <code class="docutils literal"><span class="pre">direction</span></code> will not change during the
function’s execution. The direction to move is either upward (<code class="docutils literal"><span class="pre">-1</span></code>,
from <strong>A2</strong> to <strong>A1</strong>) if the key code is 38 (<strong>UP</strong>), or downward
(<code class="docutils literal"><span class="pre">+1</span></code>, from <strong>A2</strong> to <strong>A3</strong>) otherwise.</p>
<p>Next up, we retrieve the target element using the ID selector syntax
(e.g. <code class="docutils literal"><span class="pre">&quot;#A3&quot;</span></code>), constructed with a <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/template_strings">template string</a> written in a
pair of backticks, concatenating the leading <code class="docutils literal"><span class="pre">#</span></code>, the current <code class="docutils literal"><span class="pre">col</span></code>
and the target <code class="docutils literal"><span class="pre">row</span> <span class="pre">+</span> <span class="pre">direction</span></code>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>    const cell = document.querySelector( `#${ col }${ row + direction }` );
    if (cell) { cell.focus(); }
  } );
} };
</pre></div>
</div>
<p>We put an extra check on the result of <code class="docutils literal"><span class="pre">querySelector</span></code> because moving
upward from <strong>A1</strong> will produce the selector <code class="docutils literal"><span class="pre">#A0</span></code>, which has no
corresponding element, and so will not trigger a focus change — the same
goes for pressing <strong>DOWN</strong> at the bottom row.</p>
<p>Next, we define the <code class="docutils literal"><span class="pre">reset()</span></code> function so the reset button can restore
the contents of the <code class="docutils literal"><span class="pre">sheet</span></code>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// Default sheet content, with some data cells and one formula cell.
$scope.reset = ()=&gt;{
  $scope.sheet = { A1: 1874, B1: &#39;+&#39;, C1: 2046, D1: &#39;-&gt;&#39;, E1: &#39;=A1+C1&#39; }; }
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">init()</span></code> function tries restoring the <code class="docutils literal"><span class="pre">sheet</span></code> content from its
previous state from the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/Storage#localStorage">localStorage</a>, and defaults to the initial
content if it’s our first time running the application:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// Define the initializer, and immediately call it
($scope.init = ()=&gt;{
  // Restore the previous .sheet; reset to default if it’s the first run
  $scope.sheet = angular.fromJson( localStorage.getItem( &#39;&#39; ) );
  if (!$scope.sheet) { $scope.reset(); }
  $scope.worker = new Worker( &#39;worker.js&#39; );
}).call();
</pre></div>
</div>
<p>A few things are worth nothing in the <code class="docutils literal"><span class="pre">init()</span></code> function above:</p>
<ul class="simple">
<li>We use the <code class="docutils literal"><span class="pre">($scope.init</span> <span class="pre">=</span> <span class="pre">()=&gt;{…}).call()</span></code> syntax to define the
function and immediately call it.</li>
<li>Because localStorage only stores strings, we <em>parse</em> the <code class="docutils literal"><span class="pre">sheet</span></code>
structure from its <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Glossary/JSON">JSON</a> representation using
<code class="docutils literal"><span class="pre">angular.fromJson()</span></code>.</li>
<li>At the last step of <code class="docutils literal"><span class="pre">init()</span></code>, we create a new <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/Worker">web worker</a> thread
and assign it to the <code class="docutils literal"><span class="pre">worker</span></code> scope property. Although the worker
is not directly used in the view, it’s customary to use <code class="docutils literal"><span class="pre">$scope</span></code> to
share objects used across model functions, in this case between
<code class="docutils literal"><span class="pre">init()</span></code> here and <code class="docutils literal"><span class="pre">calc()</span></code> below.</li>
</ul>
<p>While <code class="docutils literal"><span class="pre">sheet</span></code> holds the user-editable cell content, <code class="docutils literal"><span class="pre">errs</span></code> and
<code class="docutils literal"><span class="pre">vals</span></code> contain the results of calculations — errors and values — that
are read-only to the user:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// Formula cells may produce errors in .errs; normal cell contents are in .vals
[$scope.errs, $scope.vals] = [ {}, {} ];
</pre></div>
</div>
<p>With these properties in place, we can define the <code class="docutils literal"><span class="pre">calc()</span></code> function
that triggers whenever the user makes a change to <code class="docutils literal"><span class="pre">sheet</span></code>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// Define the calculation handler; not calling it yet
$scope.calc = ()=&gt;{
  const json = angular.toJson( $scope.sheet );
</pre></div>
</div>
<p>Here we take a snapshot of the state of <code class="docutils literal"><span class="pre">sheet</span></code> and store it in the
constant <code class="docutils literal"><span class="pre">json</span></code>, a JSON string. Next up, we construct a <code class="docutils literal"><span class="pre">promise</span></code>
from <a class="reference external" href="https://docs.angularjs.org/api/ng/service/$timeout">$timeout</a> that cancels the upcoming computation if it takes more
than 99 milliseconds:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>const promise = $timeout( ()=&gt;{
  // If the worker has not returned in 99 milliseconds, terminate it
  $scope.worker.terminate();
  // Back up to the previous state and make a new worker
  $scope.init();
  // Redo the calculation using the last-known state
  $scope.calc();
}, 99 );
</pre></div>
</div>
<p>Since we made sure that <code class="docutils literal"><span class="pre">calc()</span></code> is called at most once every 200
milliseconds via the <code class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">ng-model-options&gt;</span></code> attribute in HTML,
this arrangement leaves 101 milliseconds for <code class="docutils literal"><span class="pre">init()</span></code> to restore
<code class="docutils literal"><span class="pre">sheet</span></code> to the last known-good state and make a new worker.</p>
<p>The worker’s task is to calculate <code class="docutils literal"><span class="pre">errs</span></code> and <code class="docutils literal"><span class="pre">vals</span></code> from the
contents of<code class="docutils literal"><span class="pre">sheet</span></code>. Because <strong>main.js</strong> and <strong>worker.js</strong>
communicate by message-passing, we need an <code class="docutils literal"><span class="pre">onmessage</span></code> handler to
receive the results once they are ready:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// When the worker returns, apply its effect on the scope
$scope.worker.onmessage = ({data})=&gt;{
  $timeout.cancel( promise );
  localStorage.setItem( &#39;&#39;, json );
  $timeout( ()=&gt;{ [$scope.errs, $scope.vals] = data; } );
};
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">onmessage</span></code> is called, we know that the <code class="docutils literal"><span class="pre">sheet</span></code> snapshot in
<code class="docutils literal"><span class="pre">json</span></code> is stable (i.e., containing no infinite-looping formulas), so
we cancel the 99-millisecond timeout, write the snapshot to
localStorage, and schedule a UI update with a <code class="docutils literal"><span class="pre">$timeout</span></code> function that
updates <code class="docutils literal"><span class="pre">errs</span></code> and <code class="docutils literal"><span class="pre">vals</span></code> to the user-visible view.</p>
<p>With the handler in place, we can post the state of <code class="docutils literal"><span class="pre">sheet</span></code> to the
worker, starting its calculation in the background:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>    // Post the current sheet content for the worker to process
    $scope.worker.postMessage( $scope.sheet );
  };

  // Start calculation when worker is ready
  $scope.worker.onmessage = $scope.calc;
  $scope.worker.postMessage( null );
});
</pre></div>
</div>
<p class="rubric" id="js-background-worker">JS: Background Worker</p>
<p>There are three reasons for using a web worker to calculate formulas,
instead of using the main JS thread for the task:</p>
<ul class="simple">
<li>While the worker runs in the background, the user is free to continue
interacting with the spreadsheet without getting blocked by
computation in the main thread.</li>
<li>Because we accept any JS expression in a formula, the worker provides
a <em>sandbox</em> that prevents formulas from interfering with the page
that contains them, such as by popping out an <code class="docutils literal"><span class="pre">alert()</span></code> dialog box.</li>
<li>A formula can refer to any coordinates as variables. The other
coordinates may contain another formula that might end in a cyclic
reference. To solve this problem, we use the worker’s <em>global scope</em>
object <code class="docutils literal"><span class="pre">self</span></code>, and define these variables as <em>getter functions</em> on
<code class="docutils literal"><span class="pre">self</span></code> to implement the cycle-prevention logic.</li>
</ul>
<p>With these in mind, let’s take a look at the worker’s code.</p>
<p>The worker’s sole purpose is defining its <code class="docutils literal"><span class="pre">onmessage</span></code> handler. The
handler takes <code class="docutils literal"><span class="pre">sheet</span></code>, calculates <code class="docutils literal"><span class="pre">errs</span></code> and <code class="docutils literal"><span class="pre">vals</span></code>, and posts
them back to the main JS thread. We begin by re-initializing the three
variables when we receive a message:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">vals</span><span class="p">;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">onmessage</span> <span class="o">=</span> <span class="p">({</span><span class="n">data</span><span class="p">})</span><span class="o">=&gt;</span><span class="p">{</span>
  <span class="p">[</span><span class="n">sheet</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">vals</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">data</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span> <span class="p">];</span>
</pre></div>
</div>
<p>In order to turn coordinates into global variables, we first iterate
over each property in <code class="docutils literal"><span class="pre">sheet</span></code>, using a <code class="docutils literal"><span class="pre">for…in</span></code> loop:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">const</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">sheet</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<p>ES6 introduces <code class="docutils literal"><span class="pre">const</span></code> and <code class="docutils literal"><span class="pre">let</span></code> declares <em>block scoped</em> constants
and variables; <code class="docutils literal"><span class="pre">const</span> <span class="pre">coord</span></code> above means that functions defined in the
loop would capture the value of <code class="docutils literal"><span class="pre">coord</span></code> in each iteration.</p>
<p>In contrast, <code class="docutils literal"><span class="pre">var</span> <span class="pre">coord</span></code> in earlier versions of JS would declare a
<em>function scoped</em> variable, and functions defined in each loop iteration
would end up pointing to the same <code class="docutils literal"><span class="pre">coord</span></code> variable.</p>
<p>Customarily, formula variables are case-insensitive and can optionally
have a <code class="docutils literal"><span class="pre">$</span></code> prefix. Because JS variables are case-sensitive, we use
<code class="docutils literal"><span class="pre">map</span></code> to go over the four variable names for the same coordinate:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// Four variable names pointing to the same coordinate: A1, a1, $A1, $a1
[ &#39;&#39;, &#39;$&#39; ].map( p =&gt; [ coord, coord.toLowerCase() ].map(c =&gt; {
  const name = p+c;
</pre></div>
</div>
<p>Note the shorthand arrow function syntax above: <code class="docutils literal"><span class="pre">p</span> <span class="pre">=&gt;</span> <span class="pre">...</span></code> is the same
as <code class="docutils literal"><span class="pre">(p)</span> <span class="pre">=&gt;</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code>.</p>
<p>For each variable name, like <code class="docutils literal"><span class="pre">A1</span></code> and <code class="docutils literal"><span class="pre">$a1</span></code>, we define an <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty">accessor
property</a> on <code class="docutils literal"><span class="pre">self</span></code> that calculates <code class="docutils literal"><span class="pre">vals[&quot;A1&quot;]</span></code> whenever they are
evaluated in an expression:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Worker</span> <span class="ow">is</span> <span class="n">reused</span> <span class="n">across</span> <span class="n">calculations</span><span class="p">,</span> <span class="n">so</span> <span class="n">only</span> <span class="n">define</span> <span class="n">each</span> <span class="n">variable</span> <span class="n">once</span>
<span class="k">if</span> <span class="p">((</span><span class="n">Object</span><span class="o">.</span><span class="n">getOwnPropertyDescriptor</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="p">)</span> <span class="o">||</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>

<span class="o">//</span> <span class="n">Define</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">],</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span> <span class="n">thing</span> <span class="k">as</span> <span class="n">the</span> <span class="k">global</span> <span class="n">variable</span> <span class="n">A1</span>
<span class="n">Object</span><span class="o">.</span><span class="n">defineProperty</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">{</span> <span class="n">get</span><span class="p">()</span> <span class="p">{</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">{</span> <span class="pre">get()</span> <span class="pre">{</span> <span class="pre">…</span> <span class="pre">}</span> <span class="pre">}</span></code> syntax above is shorthand for
<code class="docutils literal"><span class="pre">{</span> <span class="pre">get:</span> <span class="pre">()=&gt;{</span> <span class="pre">…</span> <span class="pre">}</span> <span class="pre">}</span></code>. Because we define only <code class="docutils literal"><span class="pre">get</span></code> and not <code class="docutils literal"><span class="pre">set</span></code>,
the variables become <em>read-only</em> and cannot be modified from
user-supplied formulas.</p>
<p>The <code class="docutils literal"><span class="pre">get</span></code> accessor starts by checking <code class="docutils literal"><span class="pre">vals[coord]</span></code>, and simply
returns it if it’s already calculated:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">coord</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="n">coord</span><span class="p">];</span> <span class="p">}</span>
</pre></div>
</div>
<p>If not, we need to calculate <code class="docutils literal"><span class="pre">vals[coord]</span></code> from <code class="docutils literal"><span class="pre">sheet[coord]</span></code>.</p>
<p>First we set it to <code class="docutils literal"><span class="pre">NaN</span></code>, so self-references like setting <strong>A1</strong> to
<code class="docutils literal"><span class="pre">=A1</span></code> will end up with <code class="docutils literal"><span class="pre">NaN</span></code> instead of an infinite loop:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="n">vals</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">NaN</span><span class="p">;</span>
</pre></div>
</div>
<p>Next we check if <code class="docutils literal"><span class="pre">sheet[coord]</span></code> is a number by converting it to
numeric with prefix <code class="docutils literal"><span class="pre">+</span></code>, assigning the number to <code class="docutils literal"><span class="pre">x</span></code>, and comparing
its string representation with the original string. If they differ, then
we set <code class="docutils literal"><span class="pre">x</span></code> to the original string:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Turn</span> <span class="n">numeric</span> <span class="n">strings</span> <span class="n">into</span> <span class="n">numbers</span><span class="p">,</span> <span class="n">so</span> <span class="o">=</span><span class="n">A1</span><span class="o">+</span><span class="n">C1</span> <span class="n">works</span> <span class="n">when</span> <span class="n">both</span> <span class="n">are</span> <span class="n">numbers</span>
<span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="o">+</span><span class="n">sheet</span><span class="p">[</span><span class="n">coord</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sheet</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">!==</span> <span class="n">x</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">sheet</span><span class="p">[</span><span class="n">coord</span><span class="p">];</span> <span class="p">}</span>
</pre></div>
</div>
<p>If the initial character of <code class="docutils literal"><span class="pre">x</span></code> is <code class="docutils literal"><span class="pre">=</span></code>, then it’s a formula cell. We
evaluate the part after <code class="docutils literal"><span class="pre">=</span></code> with <code class="docutils literal"><span class="pre">eval.call()</span></code>, using the first
argument <code class="docutils literal"><span class="pre">null</span></code> to tell <code class="docutils literal"><span class="pre">eval</span></code> to run in the <em>global scope</em>, hiding
the <em>lexical scope</em> variables like <code class="docutils literal"><span class="pre">x</span></code> and <code class="docutils literal"><span class="pre">sheet</span></code> from the
evaluation:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>// Evaluate formula cells that begin with =
try { vals[coord] = ((&#39;=&#39; === x[0]) ? eval.call( null, x.slice( 1 ) ) : x);
</pre></div>
</div>
<p>If the evaluation succeeds, the result is stored into <code class="docutils literal"><span class="pre">vals[coord]</span></code>.
For non-formula cells, the value of <code class="docutils literal"><span class="pre">vals[coord]</span></code> is simply <code class="docutils literal"><span class="pre">x</span></code>,
which may be a number or a string.</p>
<p>If <code class="docutils literal"><span class="pre">eval</span></code> results in an error, the <code class="docutils literal"><span class="pre">catch</span></code> block tests if it’s
because the formula refers to an empty cell not yet defined in <code class="docutils literal"><span class="pre">self</span></code>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>} catch (e) {
  const match = /\$?[A-Za-z]+[1-9][0-9]*\b/.exec( e );
  if (match &amp;&amp; !( match[0] in self )) {
</pre></div>
</div>
<p>In that case, we set the missing cell’s default value to &quot;0&quot;, clear
<code class="docutils literal"><span class="pre">vals[coord]</span></code>, and re-run the current computation using
<code class="docutils literal"><span class="pre">self[coord]</span></code>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">The</span> <span class="n">formula</span> <span class="n">refers</span> <span class="n">to</span> <span class="n">a</span> <span class="n">uninitialized</span> <span class="n">cell</span><span class="p">;</span> <span class="nb">set</span> <span class="n">it</span> <span class="n">to</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">retry</span>
  <span class="bp">self</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">delete</span> <span class="n">vals</span><span class="p">[</span><span class="n">coord</span><span class="p">];</span>
  <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">coord</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the user gives the missing cell a content later on in
<code class="docutils literal"><span class="pre">sheet[coord]</span></code>, then the temporary value would be overridden by
<code class="docutils literal"><span class="pre">Object.defineProperty</span></code>.</p>
<p>Other kinds of errors are stored in <code class="docutils literal"><span class="pre">errs[coord]</span></code>:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Otherwise</span><span class="p">,</span> <span class="n">stringify</span> <span class="n">the</span> <span class="n">caught</span> <span class="n">exception</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">errs</span> <span class="nb">object</span>
  <span class="n">errs</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In case of errors, the value of <code class="docutils literal"><span class="pre">vals[coord]</span></code> will remain <code class="docutils literal"><span class="pre">NaN</span></code>
because the assignment did not finish executing.</p>
<p>Finally, the <code class="docutils literal"><span class="pre">get</span></code> accessor returns the calculated value stored in
<code class="docutils literal"><span class="pre">vals[coord]</span></code>, which must be a number, a Boolean value, or a string:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>      <span class="o">//</span> <span class="n">Turn</span> <span class="n">vals</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="n">into</span> <span class="n">a</span> <span class="n">string</span> <span class="k">if</span> <span class="n">it</span><span class="s1">&#39;s not a number or Boolean</span>
      <span class="n">switch</span> <span class="p">(</span><span class="n">typeof</span> <span class="n">vals</span><span class="p">[</span><span class="n">coord</span><span class="p">])</span> <span class="p">{</span>
          <span class="n">case</span> <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">case</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">vals</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span><span class="o">+=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="n">coord</span><span class="p">];</span>
    <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
  <span class="p">}));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With accessors defined for all coordinates, the worker goes through the
coordinates again, invoking each accessor with <code class="docutils literal"><span class="pre">self[coord]</span></code>, then
posts the resulting <code class="docutils literal"><span class="pre">errs</span></code> and <code class="docutils literal"><span class="pre">vals</span></code> back to the main JS thread:</p>
<div class="code javascript highlight-default"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">For</span> <span class="n">each</span> <span class="n">coordinate</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">call</span> <span class="n">the</span> <span class="nb">property</span> <span class="n">getter</span> <span class="n">defined</span> <span class="n">above</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">const</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">sheet</span><span class="p">)</span> <span class="p">{</span> <span class="bp">self</span><span class="p">[</span><span class="n">coord</span><span class="p">];</span> <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span> <span class="n">errs</span><span class="p">,</span> <span class="n">vals</span> <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric" id="css">CSS</p>
<p>The <strong>styles.css</strong> file contains just a few selectors and their
presentational styles. First, we style the table to merge all cell
borders together, leaving no spaces between neighboring cells:</p>
<div class="code css highlight-default"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="p">{</span> <span class="n">border</span><span class="o">-</span><span class="n">collapse</span><span class="p">:</span> <span class="n">collapse</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Both the heading and data cells share the same border style, but we can
tell them apart by their background colors: heading cells are light
gray, data cells are white by default, and formula cells get a light
blue background:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">th</span><span class="p">,</span> <span class="n">td</span> <span class="p">{</span> <span class="n">border</span><span class="p">:</span> <span class="mi">1</span><span class="n">px</span> <span class="n">solid</span> <span class="c1">#ccc; }</span>
<span class="n">th</span> <span class="p">{</span> <span class="n">background</span><span class="p">:</span> <span class="c1">#ddd; }</span>
<span class="n">td</span><span class="o">.</span><span class="n">formula</span> <span class="p">{</span> <span class="n">background</span><span class="p">:</span> <span class="c1">#eef; }</span>
</pre></div>
</div>
<p>The displayed width is fixed for each cell’s calculated values. Empty
cells receive a minimal height, and long lines are clipped with a
trailing ellipsis:</p>
<div class="code css highlight-default"><div class="highlight"><pre><span></span><span class="n">td</span> <span class="n">div</span> <span class="p">{</span> <span class="n">text</span><span class="o">-</span><span class="n">align</span><span class="p">:</span> <span class="n">right</span><span class="p">;</span> <span class="n">width</span><span class="p">:</span> <span class="mi">120</span><span class="n">px</span><span class="p">;</span> <span class="nb">min</span><span class="o">-</span><span class="n">height</span><span class="p">:</span> <span class="mf">1.2</span><span class="n">em</span><span class="p">;</span>
         <span class="n">overflow</span><span class="p">:</span> <span class="n">hidden</span><span class="p">;</span> <span class="n">text</span><span class="o">-</span><span class="n">overflow</span><span class="p">:</span> <span class="n">ellipsis</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The text alignment and decorations are determined by each value’s type,
as reflected by the <code class="docutils literal"><span class="pre">text</span></code> and <code class="docutils literal"><span class="pre">error</span></code> class selectors:</p>
<div class="code css highlight-default"><div class="highlight"><pre><span></span><span class="n">div</span><span class="o">.</span><span class="n">text</span> <span class="p">{</span> <span class="n">text</span><span class="o">-</span><span class="n">align</span><span class="p">:</span> <span class="n">left</span><span class="p">;</span> <span class="p">}</span>
<span class="n">div</span><span class="o">.</span><span class="n">error</span> <span class="p">{</span> <span class="n">text</span><span class="o">-</span><span class="n">align</span><span class="p">:</span> <span class="n">center</span><span class="p">;</span> <span class="n">color</span><span class="p">:</span> <span class="c1">#800; font-size: 90%; border: solid 1px #800 }</span>
</pre></div>
</div>
<p>As for the user-editable <code class="docutils literal"><span class="pre">input</span></code> box, we use <em>absolute positioning</em> to
overlay it on top of its cell, and make it transparent so the underlying
<code class="docutils literal"><span class="pre">div</span></code> with the cell’s value shows through:</p>
<div class="code css highlight-default"><div class="highlight"><pre><span></span><span class="nb">input</span> <span class="p">{</span> <span class="n">position</span><span class="p">:</span> <span class="n">absolute</span><span class="p">;</span> <span class="n">border</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span> <span class="n">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">width</span><span class="p">:</span> <span class="mi">120</span><span class="n">px</span><span class="p">;</span> <span class="n">height</span><span class="p">:</span> <span class="mf">1.3</span><span class="n">em</span><span class="p">;</span> <span class="n">font</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span><span class="p">;</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">transparent</span><span class="p">;</span> <span class="n">background</span><span class="p">:</span> <span class="n">transparent</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>When the user sets focus on the input box, it springs into the
foreground:</p>
<div class="code css highlight-default"><div class="highlight"><pre><span></span><span class="nb">input</span><span class="p">:</span><span class="n">focus</span> <span class="p">{</span> <span class="n">color</span><span class="p">:</span> <span class="c1">#111; background: #efe; }</span>
</pre></div>
</div>
<p>Furthermore, the underlying <code class="docutils literal"><span class="pre">div</span></code> is collapsed into a single line, so
it’s completely covered by the input box:</p>
<div class="code css highlight-default"><div class="highlight"><pre><span></span><span class="nb">input</span><span class="p">:</span><span class="n">focus</span> <span class="o">+</span> <span class="n">div</span> <span class="p">{</span> <span class="n">white</span><span class="o">-</span><span class="n">space</span><span class="p">:</span> <span class="n">nowrap</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p class="rubric" id="conclusion">Conclusion</p>
<p>Since this book is <em>500 Lines or Less</em>, a web spreadsheet in 99 lines is
a minimal example—please feel free to experiment and extend it in any
direction you’d like.</p>
<p>Here are some ideas, all easily reachable in the remaining space of 401
lines:</p>
<ul class="simple">
<li>A collaborative online editor using <a class="reference external" href="http://sharejs.org/">ShareJS</a>, <a class="reference external" href="http://angularfire.com">AngularFire</a> or
<a class="reference external" href="http://goangular.org/">GoAngular</a>.</li>
<li>Markdown syntax support for text cells, using <a class="reference external" href="http://ngmodules.org/modules/angular-marked">angular-marked</a>.</li>
<li>Common formula functions (<code class="docutils literal"><span class="pre">SUM</span></code>, <code class="docutils literal"><span class="pre">TRIM</span></code>, etc.) from the
<a class="reference external" href="https://en.wikipedia.org/wiki/OpenFormula">OpenFormula standard</a>.</li>
<li>Interoperate with popular spreadsheet formats, such as CSV and
SpreadsheetML via <a class="reference external" href="http://sheetjs.com/">SheetJS</a>.</li>
<li>Import from and export to online spreadsheet services, such as Google
Spreadsheet and <a class="reference external" href="http://ethercalc.net/">EtherCalc</a>.</li>
</ul>
<p class="rubric" id="a-note-on-js-versions">A Note on JS versions</p>
<p>This chapter aims to demonstrate new concepts in ES6, so we use the
<a class="reference external" href="https://github.com/google/traceur-compiler">Traceur compiler</a> to translate source code to ES5 to run on pre-2015
browsers.</p>
<p>If you prefer to work directly with the 2010 edition of JS, the
<a class="reference external" href="https://audreyt.github.io/500lines/spreadsheet/as-javascript-1.8.5/">as-javascript-1.8.5</a> directory has <strong>main.js</strong> and <strong>worker.js</strong>
written in the style of ES5; the <a class="reference external" href="https://github.com/audreyt/500lines/tree/master/spreadsheet/as-javascript-1.8.5">source code</a> is line-by-line
comparable to the ES6 version with the same line count.</p>
<p>For people preferring a cleaner syntax, the <a class="reference external" href="https://audreyt.github.io/500lines/spreadsheet/as-livescript-1.3.0/">as-livescript-1.3.0</a>
directory uses <a class="reference external" href="http://livescript.net/">LiveScript</a> instead of ES6 to write <strong>main.ls</strong> and
<strong>worker.ls</strong>; it is <a class="reference external" href="https://github.com/audreyt/500lines/tree/master/spreadsheet/as-livescript-1.3.0">20 lines shorter</a> than the JS version.</p>
<p>Building on the LiveScript language, the <a class="reference external" href="https://audreyt.github.io/500lines/spreadsheet/as-react-livescript/">as-react-livescript</a>
directory uses the <a class="reference external" href="https://facebook.github.io/react/">ReactJS</a> framework; <a class="reference external" href="https://github.com/audreyt/500lines/tree/master/spreadsheet/as-react-livescript">it is 10 lines more longer</a>
than the AngularJS equivalent, but runs considerably faster.</p>
<p>If you are interested in translating this example to alternate JS
languages, send a <a class="reference external" href="https://github.com/audreyt/500lines/pulls">pull request</a>—I’d love to hear about it!</p>
</div></div></div></div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Learn-Computer-and-Math-again</a></h1>








<h3>导航</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="blockcode-a-visual-programming-toolkit.html">500 Lines or Less | Blockcode: A visual programming toolkit</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, timger.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/chapters/web-spreadsheet.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>